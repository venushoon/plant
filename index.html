<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹ë¬¼ í•œì‚´ì´ íƒêµ¬ (Wikipedia API)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    @media print {
      .no-print { display: none !important; }
      .print-grid { grid-template-columns: 1fr 1fr; gap: 16px; }
      a::after { content: " (ë§í¬)"; font-size: 10px; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <header class="bg-white sticky top-0 z-10 border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-green-600">
        <path d="M12 2a7 7 0 00-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
      </svg>
      <div>
        <h1 class="text-xl font-bold">ì‹ë¬¼ í•œì‚´ì´ íƒêµ¬ (Wikipedia)</h1>
        <p class="text-sm text-slate-500">ê²€ìƒ‰ì–´ë¡œ ì‹ë¬¼ì„ ì…ë ¥í•˜ë©´ ë°œì•„Â·ì„±ì¥Â·ê°œí™”Â·ê²°ì‹¤, ì¢…ë¥˜ êµ¬ë¶„ê¹Œì§€ ìë™ ì •ë¦¬</p>
      </div>
      <div class="ml-auto text-xs text-slate-400">Â© ìœ„í‚¤ë°±ê³¼/Wikimedia ìë£Œ ì‚¬ìš© Â· ë¼ì´ì„ ìŠ¤ í‘œì‹œ</div>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 py-4">
    <div class="bg-white rounded-2xl shadow p-4 flex flex-col md:flex-row gap-3 items-stretch md:items-center">
      <div class="flex-1 flex gap-2">
        <input id="q" class="w-full rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸°, ë²šë‚˜ë¬´, ì†Œë‚˜ë¬´ ..." />
        <select id="lang" class="rounded-xl border px-3 py-3">
          <option value="ko" selected>í•œêµ­ì–´(ko)</option>
          <option value="en">English(en)</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="searchBtn" class="rounded-xl bg-green-600 text-white px-5 py-3 font-semibold hover:bg-green-700 transition">ê²€ìƒ‰</button>
        <button id="printBtn" class="rounded-xl border px-5 py-3 font-semibold hover:bg-slate-50 transition">ì¸ì‡„/ë°°í¬</button>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">â€» í•œêµ­ì–´ ë¬¸ì„œê°€ ë¶€ì¡±í•  ê²½ìš° ìë™ìœ¼ë¡œ ì˜ì–´ ë¬¸ì„œë¡œ ë³´ì™„ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <div id="toast" class="hidden mx-auto max-w-3xl mb-4 rounded-xl bg-amber-50 text-amber-800 border border-amber-200 px-4 py-3"></div>

    <section id="summary" class="hidden bg-white rounded-2xl shadow overflow-hidden">
      <div class="md:flex">
        <div class="md:w-1/3">
          <img id="thumb" class="w-full h-64 object-cover" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
        </div>
        <div class="p-6 md:w-2/3">
          <div class="flex items-start gap-2">
            <h2 id="title" class="text-2xl font-bold"></h2>
            <a id="wikiLink" href="#" target="_blank" class="ml-auto text-green-600 text-sm underline">ì›ë¬¸ ë³´ê¸°</a>
          </div>
          <p id="extract" class="mt-3 text-slate-700 leading-7"></p>
          <div id="meta" class="mt-3 text-xs text-slate-500"></div>
        </div>
      </div>
    </section>

    <section id="sections" class="mt-6 grid lg:grid-cols-3 gap-6 print-grid"></section>

    <section id="growthWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">í•œì‚´ì´ ê³¼ì • ìš”ì•½ (ì´ˆë“± ëˆˆë†’ì´)</h3>
      <div id="growthContent" class="bg-white rounded-2xl shadow p-5 text-slate-700 leading-7"></div>
    </section>

    <!-- ë‹¨ê³„ë³„ ì¹´ë“œ (ë™ì  ë‚´ìš© ì£¼ì…) -->
    <section id="stageCards" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ë°œì•„ â†’ ì„±ì¥ â†’ ê°œí™” â†’ ê²°ì‹¤</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <div class="text-4xl">ğŸŒ±</div>
          <div class="mt-2 font-semibold">ë°œì•„</div>
          <p id="stage-germination" class="text-sm text-slate-600 text-center mt-1"></p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <div class="text-4xl">ğŸŒ¿</div>
          <div class="mt-2 font-semibold">ì„±ì¥</div>
          <p id="stage-growth" class="text-sm text-slate-600 text-center mt-1"></p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <div class="text-4xl">ğŸŒ¼</div>
          <div class="mt-2 font-semibold">ê°œí™”</div>
          <p id="stage-flowering" class="text-sm text-slate-600 text-center mt-1"></p>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex flex-col items-center">
          <div class="text-4xl">ğŸ</div>
          <div class="mt-2 font-semibold">ê²°ì‹¤</div>
          <p id="stage-fruiting" class="text-sm text-slate-600 text-center mt-1"></p>
        </div>
      </div>
    </section>

    <!-- ì„¸ë¶€ íŠ¹ì§• ì¹´ë“œ (ì”¨ì•—/ë¿Œë¦¬/ì/ê½ƒ/í”¼ëŠ” ì‹œê¸°/ì—´ë§¤) -->
    <section id="detailWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ì„¸ë¶€ íŠ¹ì§•</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸŒ°</span><h4 class="font-semibold">ì”¨ì•—ì˜ ìƒê¹€ìƒˆ</h4></div><ul id="feat-seed" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ«š</span><h4 class="font-semibold">ë¿Œë¦¬ì˜ ëª¨ì–‘</h4></div><ul id="feat-root" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸƒ</span><h4 class="font-semibold">ìì˜ íŠ¹ì§•</h4></div><ul id="feat-leaf" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸŒ¼</span><h4 class="font-semibold">ê½ƒì˜ íŠ¹ì§•</h4></div><ul id="feat-flower" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ“…</span><h4 class="font-semibold">í”¼ëŠ” ì‹œê¸°</h4></div><ul id="feat-bloom" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2"><span class="text-2xl">ğŸ</span><h4 class="font-semibold">ì—´ë§¤ì˜ ëª¨ì–‘Â·íŠ¹ì§•</h4></div><ul id="feat-fruit" class="list-disc pl-5 mt-2 text-slate-700 leading-7"></ul></article>
      </div>
    </section>

    <!-- êµ¬ë¶„ ì¹´ë“œ (í•œí•´/ì—¬ëŸ¬í•´, ë‚˜ë¬´/ê½ƒ) -->
    <section id="classification" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ì‹ë¬¼ êµ¬ë¶„</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl shadow p-5">
          <h4 class="font-semibold mb-2">ğŸŒ ìƒìœ¡ ê¸°ê°„</h4>
          <ul id="lifeSpanInfo" class="list-disc pl-5 text-slate-700 leading-7"></ul>
        </div>
        <div class="bg-white rounded-2xl shadow p-5">
          <h4 class="font-semibold mb-2">ğŸŒ³ ì¢…ë¥˜</h4>
          <ul id="typeInfo" class="list-disc pl-5 text-slate-700 leading-7"></ul>
        </div>
      </div>
    </section>

    <section id="galleryWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ê´€ë ¨ ì‚¬ì§„Â·ì´ë¯¸ì§€</h3>
      <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      <p class="text-xs text-slate-500 mt-2">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ì›ë³¸ê³¼ ë¼ì´ì„ ìŠ¤ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <div id="status" class="mt-8 text-center text-slate-500"></div>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $('#status');

    // âœ… í•œ/ì˜ ì„¹ì…˜ í‚¤ì›Œë“œ
    const sectionMapKo = [ 'ë°œì•„','ìƒì¥','ê°œí™”','ìˆ˜ë¶„','ìˆ˜ì •','ê²°ì‹¤','ì”¨ì•—','ì—´ë§¤','ë²ˆì‹','í˜•íƒœ','íŠ¹ì§•' ];
    const sectionMapEn = [ 'Germination','Growth','Flowering','Pollination','Fertilization','Fruit','Seed','Reproduction','Characteristics','Description' ];

    // âœ… ê°„ë‹¨ alias (í•„ìš”ì‹œ í™•ì¥)
    const aliasMap = {
      'í•´ë°”ë¼ê¸°': 'Sunflower',
      'ë²šë‚˜ë¬´': 'Prunus serrulata',
      'ì†Œë‚˜ë¬´': 'Pine',
      'ì¥ë¯¸': 'Rose',
      'íŠ¤ë¦½': 'Tulip',
    };

    function apiURL(lang, path) { return `https://${lang}.wikipedia.org${path}`; }

    function showToast(msg){ const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 3000); }
    function setStatus(msg) { statusEl.textContent = msg || ''; }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    // ğŸ”§ ê²€ìƒ‰ ìœ í‹¸: ìƒìœ„ ê²°ê³¼ ì¤‘ best match ì„ ì •
    function bestSearchHit(list, q){
      if(!Array.isArray(list) || !list.length) return null;
      const lowerQ = q.toLowerCase();
      const exact = list.find(h => (h.title||'').toLowerCase() === lowerQ);
      if (exact) return exact;
      const contains = list.find(h => (h.title||'').toLowerCase().includes(lowerQ));
      if (contains) return contains;
      return list.sort((a,b)=> (a.title||'').length - (b.title||'').length)[0];
    }

    async function searchTitleRaw(query, lang){
      const url = apiURL(lang, `/w/api.php?action=query&list=search&srnamespace=0&srsearch=${encodeURIComponent(query)}&format=json&origin=*`);
      const r = await fetch(url); if(!r.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨'); return (await r.json())?.query?.search || [];
    }

    async function searchTitle(query, lang){
      let hits = await searchTitleRaw(query, lang);
      let pick = bestSearchHit(hits, query);
      if (pick) return pick.title;
      if (lang==='ko' && aliasMap[query]){
        hits = await searchTitleRaw(aliasMap[query], 'en'); pick = bestSearchHit(hits, aliasMap[query]); if (pick) return { title: pick.title, lang: 'en' };
      }
      if (lang==='ko'){
        hits = await searchTitleRaw(query, 'en'); pick = bestSearchHit(hits, query); if (pick) return { title: pick.title, lang: 'en' };
      }
      return null;
    }

    async function getSummary(title, lang) { const url = apiURL(lang, `/api/rest_v1/page/summary/${encodeURIComponent(title)}`); const r = await fetch(url); if (!r.ok) throw new Error('ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return r.json(); }
    async function getSections(title, lang) { const url = apiURL(lang, `/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=sections&format=json&origin=*`); const r = await fetch(url); const j = await r.json(); return j?.parse?.sections || []; }
    async function getSectionHTML(title, index, lang) { const url = apiURL(lang, `/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=text&section=${index}&format=json&origin=*`); const r = await fetch(url); const j = await r.json(); return j?.parse?.text?.['*'] || ''; }
    async function getMediaList(title, lang) { const url = apiURL(lang, `/api/rest_v1/page/media-list/${encodeURIComponent(title)}`); const r = await fetch(url); if (!r.ok) return { items: [] }; return r.json(); }

    function pickSectionsByLabels(sections, lang) {
      const labels = (lang === 'ko') ? sectionMapKo : sectionMapEn;
      const wanted = [];
      for (const s of sections) { const name = s?.line || ''; if (labels.some(l => name.toLowerCase().includes(l.toLowerCase()))) wanted.push({ index: s.index, name }); }
      const seen = new Set();
      return wanted.filter(w => { const key = w.name.toLowerCase(); if (seen.has(key)) return false; seen.add(key); return true; }).slice(0, 8);
    }

    function stripRefs(html) {
      return html
        .replaceAll(/<sup[^>]*class=\"reference\"[\s\S]*?<\/sup>/g, '')
        .replaceAll(/<table[^>]*class=\"infobox[\s\S]*?<\/table>/g, '')
        .replaceAll(/<style[\s\S]*?<\/style>/g, '')
        .replaceAll(/<script[\s\S]*?<\/script>/g, '')
        .replaceAll(/\s\(\s*í¸ì§‘\s*\)/g, '');
    }

    function htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html; return (tmp.textContent||tmp.innerText||'').replace(/\s+/g,' ').trim(); }
    function cardHTML(title, inner) { return `<article class="bg-white rounded-2xl shadow p-5"><h4 class="font-semibold mb-2">${title}</h4><div class="prose max-w-none">${inner}</div></article>`; }
    function imageItemHTML(item) { const thumb = item?.thumbnail?.source || item?.srcset?.[0]?.src; const src = item?.original?.source || thumb; const caption = item?.title || item?.caption?.text || ''; const credit = item?.artist?.text || item?.credit || ''; return `<a href="${src}" target="_blank" class="group block overflow-hidden rounded-xl border bg-white"><img src="${thumb}" alt="${caption}" class="w-full h-40 object-cover group-hover:scale-105 transition"/><div class="p-2 text-xs text-slate-600"><div class="truncate">${caption || 'ì´ë¯¸ì§€'}</div><div class="text-[10px] text-slate-400 truncate">${credit || ''}</div></div></a>`; }

    // === ì„¸ë¶€ ë¶„ì„ (ì¤‘ë³µ ì œê±° + ì´ˆë“± ëˆˆë†’ì´ ìš”ì•½) ===
    const uniq = (arr)=> Array.from(new Set(arr.filter(Boolean).map(s=>s.trim()))).slice(0,6);

    function analyzePlantFeatures(corpus){
      const t = corpus.toLowerCase();
      const seed=[], root=[], leaf=[], flower=[], bloom=[], fruit=[];
      // ì”¨ì•—/ì—´ë§¤ í˜•íƒœ ë‹¨ì„œ
      if(/achene|ìˆ˜ê³¼/.test(t)) { seed.push('ë‚±ì•Œê°™ì€ ì”¨(ìˆ˜ê³¼)'); fruit.push('ë§ˆë¥¸ ì—´ë§¤(ìˆ˜ê³¼)'); }
      if(/berry|ì¥ê³¼/.test(t)) fruit.push('ë¬¼ì»¹í•˜ê³  ì¦™ì´ ë§ì€ ì—´ë§¤(ì¥ê³¼)');
      if(/drupe|í•µê³¼/.test(t)) fruit.push('ì”¨ê°€ ë”±ë”±í•œ í•µê³¼');
      if(/capsule|ì‚­ê³¼/.test(t)) fruit.push('ìµìœ¼ë©´ í„°ì§€ëŠ” ì‚­ê³¼');
      if(/samara|ì‹œë§ˆë¼|ë‚ ê°œ(?:ë‹¬ë¦°)? ì—´ë§¤/.test(t)) fruit.push('ë‚ ê°œ ë‹¬ë¦° ì—´ë§¤(ë°”ëŒìœ¼ë¡œ ì´ë™)');
      if(/cone|êµ¬ê³¼|strobilus/.test(t)) fruit.push('ì†”ë°©ìš¸ ê°™ì€ êµ¬ê³¼');

      // ë¿Œë¦¬
      if(/taproot|ì›ë¿Œë¦¬/.test(t)) root.push('ì›ë¿Œë¦¬(êµµì€ ë¿Œë¦¬ í•˜ë‚˜ê°€ ê¸¸ê²Œ)');
      if(/fibrous root|ìˆ˜ì—¼ë¿Œë¦¬/.test(t)) root.push('ìˆ˜ì—¼ë¿Œë¦¬(ê°€ëŠ” ë¿Œë¦¬ê°€ ì—¬ëŸ¬ ê°ˆë˜)');
      if(/rhizome|ë•…ì†ì¤„ê¸°/.test(t)) root.push('ë•…ì†ì¤„ê¸°ë¡œ ë²ˆì‹');
      if(/tuber|ë©ì´ì¤„ê¸°/.test(t)) root.push('ë©ì´ì¤„ê¸° ì €ì¥');
      if(/bulb|ë¹„ëŠ˜ì¤„ê¸°/.test(t)) root.push('ë¹„ëŠ˜ì¤„ê¸°(ì•Œë¿Œë¦¬)');

      // ì
      if(/opposite|ë§ˆì£¼ë‚˜ê¸°/.test(t)) leaf.push('ìì´ ë§ˆì£¼ë‚˜ê¸°');
      if(/alternate|ì–´ê¸‹ë‚˜ê¸°/.test(t)) leaf.push('ìì´ ì–´ê¸‹ë‚˜ê¸°');
      if(/whorled|ëŒë ¤ë‚˜ê¸°/.test(t)) leaf.push('ìì´ ëŒë ¤ë‚˜ê¸°');
      if(/simple leaf|í™‘ì/.test(t)) leaf.push('í™‘ì');
      if(/compound leaf|ê²¹ì/.test(t)) leaf.push('ê²¹ì');
      if(/needle|ë°”ëŠ˜ì/.test(t)) leaf.push('ë°”ëŠ˜ ê°™ì€ ì');
      if(/broadleaf|ë„“ì€ì/.test(t)) leaf.push('ë„“ì€ ì');

      // ê½ƒ
      if(/inflorescence|í™”ì„œ|head\b|ë‘ìƒí™”ì„œ|raceme|panicle|spike|umbel/.test(t)) flower.push('ê½ƒì´ ëª¨ì—¬ í”¼ëŠ” í™”ì„œ íŠ¹ì§•');
      if(/petal|ê½ƒì|sepal|ê½ƒë°›ì¹¨/.test(t)) flower.push('ê½ƒìÂ·ê½ƒë°›ì¹¨ êµ¬ì¡° ë‹¨ì„œ');
      if(/color|yellow|white|red|pink|purple|ë…¸ë€|í•˜ì–€|ë¶‰|ë¶„í™|ë³´ë¼/.test(t)) flower.push('ê½ƒ ìƒ‰ê¹” ë‹¨ì„œ');

      // í”¼ëŠ” ì‹œê¸° (ì›”/ê³„ì ˆ)
      const monthMatch = t.match(/(\d{1,2})\s*[-~â€“]\s*(\d{1,2})\s*ì›”/);
      if(monthMatch){ bloom.push(`${monthMatch[1]}~${monthMatch[2]}ì›”`); }
      if(/ë´„|spring/.test(t)) bloom.push('ë´„');
      if(/ì—¬ë¦„|summer/.test(t)) bloom.push('ì—¬ë¦„');
      if(/ê°€ì„|autumn|fall\b/.test(t)) bloom.push('ê°€ì„');
      if(/ê²¨ìš¸|winter/.test(t)) bloom.push('ê²¨ìš¸');

      // ì”¨ì•—ì— ëŒ€í•œ ì¼ë°˜ ë‹¨ì„œ
      if(/seed|ì”¨ì•—/.test(t) && seed.length===0) seed.push('ì”¨ì•—ìœ¼ë¡œ ë²ˆì‹');

      return {
        seed: uniq(seed), root: uniq(root), leaf: uniq(leaf), flower: uniq(flower), bloom: uniq(bloom), fruit: uniq(fruit)
      };
    }

    function generateElementaryGrowth(corpus){
      const t = corpus.toLowerCase();
      const steps=[];
      // ë°œì•„
      steps.push('â‘  ì”¨ì•—ì´ ë¬¼ì„ ë§Œë‚˜ ê»ì§ˆì´ ë¶€ë“œëŸ¬ì›Œì§€ë©´ ì‘ì€ ë¿Œë¦¬ì™€ ì‹¹ì´ ë‚˜ì™€ìš”.');
      // ì„±ì¥
      if(/taproot|ì›ë¿Œë¦¬/.test(t)) steps.push('â‘¡ ì›ë¿Œë¦¬ê°€ ê¸¸ê²Œ ìë¼ë©° ì¤„ê¸°ì™€ ìì´ ë¬´ëŸ­ë¬´ëŸ­ ì»¤ì ¸ìš”.');
      else if(/fibrous root|ìˆ˜ì—¼ë¿Œë¦¬/.test(t)) steps.push('â‘¡ ìˆ˜ì—¼ë¿Œë¦¬ê°€ ì—¬ëŸ¬ ê°ˆë˜ë¡œ ë»—ì–´ ì‹ë¬¼ì„ ë‹¨ë‹¨íˆ ë¶™ì¡ì•„ìš”.');
      else steps.push('â‘¡ ë¿Œë¦¬ê°€ ìë¼ë©° ì¤„ê¸°ì™€ ìì´ ë„“ì–´ì ¸ í–‡ë¹›ì„ ë°›ì•„ìš”.');
      // ê°œí™”
      if(/spring|ë´„/.test(t)) steps.push('â‘¢ ë´„ì— ê½ƒì´ í”¼ì–´ ê³¤ì¶©Â·ë°”ëŒì´ ê½ƒê°€ë£¨ë¥¼ ì˜®ê²¨ìš”.');
      else if(/summer|ì—¬ë¦„/.test(t)) steps.push('â‘¢ ì—¬ë¦„ì— ê½ƒì´ í”¼ì–´ ìˆ˜ë¶„ì´ ì¼ì–´ë‚˜ìš”.');
      else steps.push('â‘¢ ê½ƒì´ í”¼ë©´ ìˆ˜ë¶„(ê½ƒê°€ë£¨ ì˜®ê¹€)ê³¼ ìˆ˜ì •ì´ ì´ë£¨ì–´ì ¸ìš”.');
      // ê²°ì‹¤
      if(/berry|ì¥ê³¼|drupe|í•µê³¼|achene|ìˆ˜ê³¼|capsule|ì‚­ê³¼|samara|êµ¬ê³¼|cone/.test(t)) steps.push('â‘£ ì”¨ì•—ì´ ë“¤ì–´ ìˆëŠ” ì—´ë§¤ê°€ ì—¬ë¬¼ì–´ í¼ì§ˆ ì¤€ë¹„ë¥¼ í•´ìš”.');
      else steps.push('â‘£ ê½ƒì´ ì§€ê³  ì—´ë§¤ê°€ ë§ºí˜€ ì”¨ì•—ì„ ë§Œë“¤ì–´ í¼ëœ¨ë ¤ìš”.');
      return steps.map(s=>`<li>${s}</li>`).join('');
    }

    function generateClassification(summaryText){
      const lifeSpan=[]; const type=[]; const t = (summaryText||'').toLowerCase();
      if(/í•œí•´ì‚´ì´|annual/.test(t)) lifeSpan.push('ğŸŒ¼ í•œí•´ì‚´ì´ ì‹ë¬¼ (1ë…„ ì£¼ê¸°)');
      if(/ë‘í•´ì‚´ì´|biennial/.test(t)) lifeSpan.push('ğŸŒ¿ ë‘í•´ì‚´ì´ ì‹ë¬¼ (2ë…„ ì£¼ê¸°)');
      if(/ì—¬ëŸ¬í•´ì‚´ì´|ë‹¤ë…„ìƒ|perennial/.test(t)) lifeSpan.push('ğŸ€ ì—¬ëŸ¬í•´ì‚´ì´ ì‹ë¬¼ (ì—¬ëŸ¬ í•´)');
      if(/ë‚˜ë¬´|ìˆ˜ëª©|tree/.test(t)) type.push('ğŸŒ³ ë‚˜ë¬´ë¥˜(ëª©ë³¸ì‹ë¬¼)');
      if(/ê½ƒ|í™”ì´ˆ|flower|herbaceous/.test(t)) type.push('ğŸŒ¸ ê½ƒ ì‹ë¬¼(ì´ˆë³¸ì‹ë¬¼)');
      return {lifeSpan: uniq(lifeSpan), type: uniq(type)};
    }

    async function run(query, lang) {
      try {
        setStatus('ê²€ìƒ‰ ì¤‘â€¦'); showToast('ê²€ìƒ‰ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
        hide($('#summary')); hide($('#galleryWrap')); hide($('#growthWrap')); hide($('#stageCards')); hide($('#classification')); hide($('#detailWrap'));
        $('#sections').innerHTML = ''; $('#gallery').innerHTML = '';

        let title = null; let usedLang = lang;
        const first = await searchTitle(query, lang);
        if (typeof first === 'object' && first?.title){ title = first.title; usedLang = first.lang || lang; }
        else if (typeof first === 'string') { title = first; }

        if (!title) { setStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•™ëª…ìœ¼ë¡œ ì‹œë„í•˜ì„¸ìš”.'); showToast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ì˜ì–´ ì´ë¦„/í•™ëª…ìœ¼ë¡œ ë‹¤ì‹œ ê²€ìƒ‰í•´ ë³´ì„¸ìš”.'); return; }

        const summary = await getSummary(title, usedLang);
        $('#title').textContent = summary.title || title;
        $('#extract').textContent = summary.extract || '';
        $('#thumb').src = summary.thumbnail?.source || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';
        $('#wikiLink').href = summary.content_urls?.desktop?.page || apiURL(usedLang, `/wiki/${encodeURIComponent(title)}`);
        $('#meta').textContent = `ì–¸ì–´: ${usedLang.toUpperCase()} Â· ë¬¸ì„œ ID: ${summary.pageid || '-'} Â· ë¶„ë¥˜: ${summary.description || ''}`;
        show($('#summary'));

        // ì„¹ì…˜ ìˆ˜ì§‘ ë° ë³¸ë¬¸ corpus êµ¬ì„± (ì¤‘ë³µ ì œê±° ëŒ€ë¹„)
        const sections = await getSections(summary.title || title, usedLang);
        const picks = pickSectionsByLabels(sections, usedLang);
        const secWrap = $('#sections');
        const corpusParts = [summary.extract || ''];
        if (picks.length) {
          for (const p of picks) {
            const html = await getSectionHTML(summary.title || title, p.index, usedLang);
            const clean = stripRefs(html);
            const div = document.createElement('div'); div.innerHTML = cardHTML(p.name, clean);
            div.querySelectorAll('a').forEach(a=>a.setAttribute('target','_blank'));
            secWrap.appendChild(div.firstElementChild);
            corpusParts.push(htmlToText(clean));
          }
        }
        const corpus = corpusParts.join(' \n ');

        // ğŸ”¹ í•œì‚´ì´ ê³¼ì • ìš”ì•½ (ì´ˆë“±)
        const growthList = generateElementaryGrowth(corpus);
        $('#growthContent').innerHTML = `<ul class="list-disc pl-5">${growthList}</ul>`;
        show($('#growthWrap'));

        // ğŸ”¹ ì„¸ë¶€ íŠ¹ì§• ë¶„ì„ + ì¹´ë“œ ì£¼ì…
        const feats = analyzePlantFeatures(corpus);
        const fill = (id, arr, alt)=>{ const el = document.getElementById(id); el.innerHTML = (arr.length? arr: [alt]).map(s=>`<li>${s}</li>`).join(''); };
        fill('feat-seed', feats.seed, 'ì”¨ì•— ëª¨ì–‘ ì •ë³´ê°€ ì ì–´ìš”. ê´€ì°°í•˜ë©° ê¸°ë¡í•´ ë³´ì„¸ìš”.');
        fill('feat-root', feats.root, 'ë¿Œë¦¬ ëª¨ì–‘ ë‹¨ì„œê°€ ì ì–´ìš”. ì›ë¿Œë¦¬/ìˆ˜ì—¼ë¿Œë¦¬ì¸ì§€ ì‚´í´ë³´ì„¸ìš”.');
        fill('feat-leaf', feats.leaf, 'ìì˜ ë‚œí˜•/ë°”ëŠ˜ì, ë§ˆì£¼/ì–´ê¸‹ë‚˜ê¸°ë¥¼ ê´€ì°°í•´ ë³´ì„¸ìš”.');
        fill('feat-flower', feats.flower, 'ê½ƒì ìˆ˜Â·ìƒ‰ê¹”Â·ëª¨ì—¬ í”¼ëŠ”ì§€(í™”ì„œ)ë¥¼ ê´€ì°°í•´ ë³´ì„¸ìš”.');
        fill('feat-bloom', feats.bloom, 'í”¼ëŠ” ë‹¬(ì˜ˆ: 4~5ì›”)ì´ë‚˜ ê³„ì ˆ ë‹¨ì„œë¥¼ ì°¾ì•„ë³´ì„¸ìš”.');
        fill('feat-fruit', feats.fruit, 'ì—´ë§¤ê°€ ë¬¼ëŸ¬ìš”? ë”±ë”±í•´ìš”? ë‚ ê°œê°€ ìˆë‚˜ìš”? ê¸°ë¡í•´ ë³´ì„¸ìš”.');
        show($('#detailWrap'));

        // ğŸ”¹ ë‹¨ê³„ë³„ ì¹´ë“œì— ì„¸ë¶€ ë¬¸ì¥ ì£¼ì… (ì¤‘ë³µ/ë°˜ë³µ ì¤„ì´ê¸°)
        const stageTxt = {
          germination: feats.seed[0] ? `ì”¨ì•—ì´ ê¹¨ì–´ë‚˜ìš”: ${feats.seed[0]}.` : 'ì”¨ì•—ì´ ë¬¼ì„ ë§ˆì‹œê³  ê»ì§ˆì´ ë¶€ë“œëŸ¬ì›Œì ¸ ì‹¹ì´ ë‚˜ì™€ìš”.',
          growth: (feats.root[0]||feats.leaf[0]) ? `ë¿Œë¦¬Â·ìì´ ìë¼ìš”: ${(feats.root[0]||'ë¿Œë¦¬ ìëŒ')}, ${(feats.leaf[0]||'ìì´ ë„“ì–´ì§')}.` : 'ë¿Œë¦¬Â·ì¤„ê¸°Â·ìì´ ì»¤ì§€ë©° í–‡ë¹›ì„ ë°›ì•„ìš”.',
          flowering: (feats.flower[0]||feats.bloom[0]) ? `ê½ƒì´ í´ìš”: ${(feats.flower[0]||'ê½ƒ êµ¬ì¡°')}, ${(feats.bloom[0]||'ê³„ì ˆ ë‹¨ì„œ')}.` : 'ê½ƒì´ í”¼ê³  ê½ƒê°€ë£¨ê°€ ì˜®ê²¨ê°€ìš”.',
          fruiting: feats.fruit[0] ? `ì—´ë§¤ê°€ ì—¬ë¬¼ì–´ìš”: ${feats.fruit[0]}.` : 'ì—´ë§¤ê°€ ë§ºí˜€ ì”¨ì•—ì„ ë§Œë“¤ê³  í¼ì ¸ìš”.'
        };
        document.getElementById('stage-germination').textContent = stageTxt.germination;
        document.getElementById('stage-growth').textContent = stageTxt.growth;
        document.getElementById('stage-flowering').textContent = stageTxt.flowering;
        document.getElementById('stage-fruiting').textContent = stageTxt.fruiting;
        show($('#stageCards'));

        // ğŸ”¹ êµ¬ë¶„ ì¹´ë“œ (í•œí•´/ì—¬ëŸ¬í•´, ë‚˜ë¬´/ê½ƒ)
        const {lifeSpan, type} = generateClassification(corpus);
        const lifeEl = document.getElementById('lifeSpanInfo');
        const typeEl = document.getElementById('typeInfo');
        lifeEl.innerHTML = (lifeSpan.length? lifeSpan : ['ìƒìœ¡ ê¸°ê°„ ë‹¨ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.']).map(x=>`<li>${x}</li>`).join('');
        typeEl.innerHTML = (type.length? type : ['ì¢…ë¥˜ ë‹¨ì„œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.']).map(x=>`<li>${x}</li>`).join('');
        show($('#classification'));

        // ğŸ”¹ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
        const media = await getMediaList(summary.title || title, usedLang);
        const images = (media.items || []).filter(x => x.type === 'image' || x?.type === 'mediainfo');
        if (images.length) { $('#gallery').innerHTML = images.slice(0, 16).map(imageItemHTML).join(''); show($('#galleryWrap')); }

        setStatus('');
      } catch (e) {
        console.error(e);
        setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”. ê°œë°œì ë„êµ¬(Console)ì—ì„œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” CORS ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('searchBtn').addEventListener('click', () => run(document.getElementById('q').value.trim() || 'í•´ë°”ë¼ê¸°', document.getElementById('lang').value));
    document.getElementById('q').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('searchBtn').click(); });
    document.getElementById('printBtn').addEventListener('click', () => window.print());

    // ì´ˆê¸° ì‹¤í–‰ ì˜ˆì‹œ
    window.addEventListener('DOMContentLoaded', () => run('í•´ë°”ë¼ê¸°', 'ko'));
  </script>
</body>
</html>
