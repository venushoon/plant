<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹ë¬¼ì˜ í•œì‚´ì´ íƒêµ¬ (Wikipedia + GBIF + EOL + iNaturalist + êµ­ë‚´ì‚¬ì´íŠ¸ ì„ íƒ)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .prose :where(p,li){line-height:1.8}
    @media print {
      .no-print { display: none !important; }
      .print-grid { grid-template-columns: 1fr 1fr; gap: 16px; }
      a::after { content: " (ë§í¬)"; font-size: 10px; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <header class="bg-white sticky top-0 z-10 border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-emerald-600">
        <path d="M12 2a7 7 0 00-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
      </svg>
      <div>
        <h1 class="text-xl font-bold">ì‹ë¬¼ì˜ í•œì‚´ì´ íƒêµ¬</h1>
        <p class="text-sm text-slate-500">Wikipedia ê¸°ë³¸ + (GBIF / EOL / iNaturalist / êµ­ë‚´: NIBRÂ·KoAGI ì„ íƒ)</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="printBtn" class="no-print rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50 transition">ì¸ì‡„/ë°°í¬</button>
        <div class="text-xs text-slate-400">Â© Wikipedia Â· GBIF Â· EOL Â· iNaturalist Â· NIBR Â· KoAGI</div>
      </div>
    </div>
  </header>

  <section class="max-w-7xl mx-auto px-4 py-4">
    <div class="bg-white rounded-2xl shadow p-4 space-y-3">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
        <div class="flex-1 flex gap-2">
          <input id="q" class="w-full rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸°, ë²šë‚˜ë¬´, ì†Œë‚˜ë¬´ ..." />
          <select id="lang" class="rounded-xl border px-3 py-3">
            <option value="ko" selected>í•œêµ­ì–´(ko)</option>
            <option value="en">English(en)</option>
          </select>
        </div>
        <div class="flex gap-2">
          <button id="searchBtn" class="rounded-xl bg-emerald-600 text-white px-5 py-3 font-semibold hover:bg-emerald-700 transition">ê²€ìƒ‰</button>
        </div>
      </div>

      <details class="no-print rounded-xl border p-3">
        <summary class="cursor-pointer font-semibold">ë°ì´í„° ì†ŒìŠ¤ ì˜µì…˜ (í•„ìš”í•œ ê²ƒë§Œ ì¼œê¸°)</summary>
        <div class="mt-3 grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="flex items-center gap-2"><input id="optGBIF" type="checkbox" class="accent-emerald-600" checked> <span>GBIF (ë¶„ë¥˜/ë¶„í¬ ë³´ê°• Â· CORS í—ˆìš©)</span></label>
            <label class="flex items-center gap-2"><input id="optEOL" type="checkbox" class="accent-emerald-600"> <span>EOL (ì„¤ëª…/ì´ë¯¸ì§€ ë³´ê°• Â· CORS í™˜ê²½ì— ë”°ë¼ ë‹¤ë¦„)</span></label>
            <label class="flex items-center gap-2"><input id="optINat" type="checkbox" class="accent-emerald-600" checked> <span>iNaturalist (ì‹¤ì œ ê´€ì°° ì‚¬ì§„ Â· CORS í—ˆìš©)</span></label>
          </div>
          <div class="space-y-2">
            <label class="flex items-center gap-2"><input id="optNIBR" type="checkbox" class="accent-emerald-600"> <span>êµ­ë¦½ìƒë¬¼ìì›ê´€ (êµ­ë‚´ ë„ê° í…ìŠ¤íŠ¸ Â· í”„ë¡ì‹œ í•„ìš”)</span></label>
            <label class="flex items-center gap-2"><input id="optKoagi" type="checkbox" class="accent-emerald-600"> <span>KoAGI ì •ì›ì‹ë¬¼ì •ë³´ (êµ­ë‚´ ë„ê° í…ìŠ¤íŠ¸ Â· í”„ë¡ì‹œ í•„ìš”)</span></label>
            <div class="flex items-center gap-2">
              <label class="w-28 text-sm text-slate-600">í”„ë¡ì‹œ</label>
              <input id="proxyURL" class="flex-1 rounded-lg border px-3 py-2" value="https://r.jina.ai/" />
              <button id="proxyTest" class="rounded-lg border px-3 py-2 text-sm">í…ŒìŠ¤íŠ¸</button>
            </div>
            <p class="text-xs text-slate-500">â€» í”„ë¡ì‹œëŠ” HTMLì„ í…ìŠ¤íŠ¸ë¡œ ì¤‘ê³„í•©ë‹ˆë‹¤(ì½ê¸° ì „ìš©). ê¸°ê´€ë§ì—ì„œ ì°¨ë‹¨ ì‹œ ë‹¤ë¥¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
          </div>
        </div>
      </details>
    </div>
    <p class="text-xs text-slate-500 mt-2">â€» ê¸°ë³¸ì€ Wikipediaë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤. ì˜µì…˜ì„ ì¼œë©´ ê° ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì¶”ê°€ë¡œ ë³‘í•©í•©ë‹ˆë‹¤.</p>
  </section>

  <main class="max-w-7xl mx-auto px-4 pb-20">
    <div id="toast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 max-w-md w-full z-20 rounded-xl bg-amber-50 text-amber-800 border border-amber-200 px-4 py-3 shadow-lg"></div>
    <div id="status" class="mt-8 text-center text-slate-500"></div>

    <section id="summary" class="hidden bg-white rounded-2xl shadow overflow-hidden">
      <div class="md:flex">
        <div class="md:w-1/3">
          <img id="thumb" class="w-full h-64 object-cover" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
        </div>
        <div class="p-6 md:w-2/3">
          <div class="flex items-start gap-2">
            <h2 id="title" class="text-2xl font-bold"></h2>
            <a id="wikiLink" href="#" target="_blank" class="ml-auto text-emerald-600 text-sm underline">ì›ë¬¸ ë³´ê¸°</a>
          </div>
          <p id="extract" class="mt-3 text-slate-700 leading-7"></p>
          <div id="meta" class="mt-3 text-xs text-slate-500"></div>
        </div>
      </div>
    </section>

    <section id="sections" class="mt-6 grid lg:grid-cols-3 gap-6 print-grid"></section>

    <section id="growthWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">í•œì‚´ì´ ê³¼ì • ìš”ì•½ (ì´ˆë“± ëˆˆë†’ì´)</h3>
      <div id="growthContent" class="bg-white rounded-2xl shadow p-5 text-slate-700 leading-7"></div>
    </section>

    <section id="stageCards" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ë°œì•„ â†’ ì„±ì¥ â†’ ê°œí™” â†’ ê²°ì‹¤ (ì„¸ë¶€íŠ¹ì§• ë°˜ì˜)</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ±</div>
          <div class="mt-2 font-semibold">ë°œì•„</div>
          <p id="stage-germination" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ¿</div>
          <div class="mt-2 font-semibold">ì„±ì¥</div>
          <p id="stage-growth" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ¼</div>
          <div class="mt-2 font-semibold">ê°œí™”</div>
          <p id="stage-flowering" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸ</div>
          <div class="mt-2 font-semibold">ê²°ì‹¤</div>
          <p id="stage-fruiting" class="text-sm text-slate-600 mt-1"></p>
        </article>
      </div>
    </section>

    <section id="detailWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ì„¸ë¶€ íŠ¹ì§•</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ°</span><h4 class="font-semibold">ì”¨ì•—ì˜ ìƒê¹€ìƒˆ</h4></div><ul id="feat-seed" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ«š</span><h4 class="font-semibold">ë¿Œë¦¬ì˜ ëª¨ì–‘</h4></div><ul id="feat-root" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸƒ</span><h4 class="font-semibold">ìì˜ íŠ¹ì§•</h4></div><ul id="feat-leaf" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ¿</span><h4 class="font-semibold">ì¤„ê¸°ì˜ íŠ¹ì§•</h4></div><ul id="feat-stem" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ¼</span><h4 class="font-semibold">ê½ƒì˜ íŠ¹ì§•</h4></div><ul id="feat-flower" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ“…</span><h4 class="font-semibold">í”¼ëŠ” ì‹œê¸°</h4></div><ul id="feat-bloom" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ</span><h4 class="font-semibold">ì—´ë§¤ì˜ ëª¨ì–‘Â·íŠ¹ì§•</h4></div><ul id="feat-fruit" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5 md:col-span-3"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸª¶</span><h4 class="font-semibold">ìˆ˜ë¶„ ë°©ë²•(ê½ƒê°€ë£¨ë°›ì´)</h4></div><ul id="feat-pollination" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
      </div>
    </section>

    <section id="sourcesWrap" class="mt-6 grid md:grid-cols-2 gap-4"></section>

    <section id="galleryWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ê´€ë ¨ ì‚¬ì§„Â·ì´ë¯¸ì§€</h3>
      <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      <p class="text-xs text-slate-500 mt-2">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ì›ë³¸ê³¼ ë¼ì´ì„ ìŠ¤ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </section>
  </main>

  <script>
    const PlantExplorer = {
      // --- ì„¤ì • ë° ìƒìˆ˜ ---
      constants: {
        sectionMapKo: ['ë°œì•„','ìƒì¥','ê°œí™”','ìˆ˜ë¶„','ìˆ˜ì •','ê²°ì‹¤','ì”¨ì•—','ì—´ë§¤','ë²ˆì‹','í˜•íƒœ','íŠ¹ì§•','ìƒíƒœ','ì„œì‹','ë¶„í¬'],
        sectionMapEn: ['Germination','Growth','Flowering','Pollination','Fertilization','Fruit','Seed','Reproduction','Characteristics','Description','Ecology','Habitat','Distribution'],
        aliasMap: { 'í•´ë°”ë¼ê¸°': 'Sunflower','ë²šë‚˜ë¬´': 'Prunus serrulata','ì†Œë‚˜ë¬´': 'Pine','ì¥ë¯¸': 'Rose','íŠ¤ë¦½': 'Tulip','ë¯¼ë“¤ë ˆ':'Taracum','ë¬´ê¶í™”':'Hibiscus syriacus' }
      },

      // --- DOM ìš”ì†Œ ìºì‹± ---
      elements: {
        status: document.getElementById('status'),
        toast: document.getElementById('toast'),
        summary: document.getElementById('summary'),
        galleryWrap: document.getElementById('galleryWrap'),
        growthWrap: document.getElementById('growthWrap'),
        stageCards: document.getElementById('stageCards'),
        detailWrap: document.getElementById('detailWrap'),
        sections: document.getElementById('sections'),
        gallery: document.getElementById('gallery'),
        sourcesWrap: document.getElementById('sourcesWrap'),
      },

      // --- API í˜¸ì¶œ ê´€ë ¨ í•¨ìˆ˜ ---
      api: {
        async fetchJSON(url) {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.json();
        },
        async fetchText(url) {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return response.text();
        },
        async searchTitleRaw(query, lang) {
          const url = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srnamespace=0&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
          const data = await this.fetchJSON(url);
          return data?.query?.search || [];
        },
        async searchTitle(query, lang) {
          const { aliasMap } = PlantExplorer.constants;
          const { bestSearchHit } = PlantExplorer.utils;
          let hits = await this.searchTitleRaw(query, lang);
          let pick = bestSearchHit(hits, query);
          if (pick) return { title: pick.title, lang };
          if (lang === 'ko' && aliasMap[query]) {
            hits = await this.searchTitleRaw(aliasMap[query], 'en');
            pick = bestSearchHit(hits, aliasMap[query]);
            if (pick) return { title: pick.title, lang: 'en' };
          }
          if (lang === 'ko') {
            hits = await this.searchTitleRaw(query, 'en');
            pick = bestSearchHit(hits, query);
            if (pick) return { title: pick.title, lang: 'en' };
          }
          return null;
        },
        getSummary(title, lang) { return this.fetchJSON(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`); },
        getSections(title, lang) { return this.fetchJSON(`https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=sections&format=json&origin=*`); },
        getSectionHTML(title, index, lang) { return this.fetchJSON(`https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=text&section=${index}&format=json&origin=*`); },
        getMediaList(title, lang) { return this.fetchJSON(`https://${lang}.wikipedia.org/api/rest_v1/page/media-list/${encodeURIComponent(title)}`); },
        
        async fetchGBIF(name) {
          try {
            const data = await this.fetchJSON(`https://api.gbif.org/v1/species/search?q=${encodeURIComponent(name)}`);
            const item = (data.results || [])[0];
            if (!item) return null;
            const bits = ['kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species'].map(rank => item[rank] ? `${rank.charAt(0).toUpperCase()}: ${item[rank]}` : null).filter(Boolean);
            return { type: 'gbif', text: bits.join(' Â· '), item };
          } catch (e) { console.warn('[GBIF]', e); return null; }
        },
        async fetchINat(name) {
          try {
            const data = await this.fetchJSON(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(name)}&per_page=12`);
            return (data.results || []).map(t => {
              const p = t.default_photo;
              return p && p.square_url ? { thumb: p.medium_url || p.square_url, src: p.url || p.large_url || p.medium_url || p.square_url, caption: t.preferred_common_name || t.name || 'iNaturalist', credit: p.attribution || 'iNaturalist' } : null;
            }).filter(Boolean);
          } catch (e) { console.warn('[INat]', e); return []; }
        },
        async fetchEOL(name, proxy) {
          try {
            const searchData = await this.fetchJSON(`https://eol.org/api/search/1.0.json?q=${encodeURIComponent(name)}`);
            const id = (searchData.results || [])[0]?.id;
            if (id) {
              const pageData = await this.fetchJSON(`https://eol.org/api/pages/1.0.json?id=${id}&details=true&images_per_page=5&texts_per_page=5`);
              const texts = (pageData.dataObjects || []).filter(o => o.dataType?.includes('Text')).map(o => o.description).join(' ');
              const images = (pageData.dataObjects || []).filter(o => o.dataType?.includes('StillImage') && o.eolMediaURL).map(o => ({ thumb: o.eolThumbnailURL || o.thumbnailURL || o.eolMediaURL, src: o.eolMediaURL, caption: o.title || 'EOL Image', credit: o.rightsHolder || o.license || 'EOL' }));
              return { type: 'eol', text: texts, images };
            }
          } catch (e) {
            console.warn('[EOL API]', e, 'Falling back to proxy.');
            try {
              const url = `https://eol.org/search?q=${encodeURIComponent(name)}`;
              const text = await this.fetchText(`${proxy}${url}`);
              return { type: 'eol', text, images: [] };
            } catch (proxyErr) { console.warn('[EOL Proxy]', proxyErr); }
          }
          return null;
        },
        async fetchProxyText(url, proxy) {
          try {
            return await this.fetchText(`${proxy}${url}`);
          } catch (e) { console.warn('[Proxy]', url, e); return ''; }
        }
      },
      
      // --- UI ì¡°ì‘ ê´€ë ¨ í•¨ìˆ˜ ---
      ui: {
        setStatus(msg = '') { PlantExplorer.elements.status.textContent = msg; },
        toast(msg) {
          const t = PlantExplorer.elements.toast;
          t.textContent = msg;
          t.classList.remove('hidden');
          setTimeout(() => t.classList.add('hidden'), 2800);
        },
        toggle(el, forceShow) { el.classList.toggle('hidden', !forceShow); },
        resetUI() {
          Object.values(PlantExplorer.elements).forEach(el => el.classList.add('hidden'));
          this.setStatus('ê²€ìƒ‰ ì¤‘â€¦');
          ['sections', 'gallery', 'sourcesWrap'].forEach(id => document.getElementById(id).innerHTML = '');
        },
        renderSummary(summary, usedLang) {
          document.getElementById('title').textContent = summary.title;
          document.getElementById('extract').textContent = summary.extract || '';
          document.getElementById('thumb').src = summary.thumbnail?.source || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';
          document.getElementById('wikiLink').href = summary.content_urls?.desktop?.page || `https://${usedLang}.wikipedia.org/wiki/${encodeURIComponent(summary.title)}`;
          document.getElementById('meta').textContent = `ì–¸ì–´: ${usedLang.toUpperCase()} Â· í˜ì´ì§€ ID: ${summary.pageid || '-'} Â· ì„¤ëª…: ${summary.description || ''}`;
          this.toggle(PlantExplorer.elements.summary, true);
        },
        async renderSections(title, sections, lang) {
          const secWrap = PlantExplorer.elements.sections;
          const { pickSectionsByLabels, stripRefs, htmlToText } = PlantExplorer.utils;
          const picks = pickSectionsByLabels(sections.parse?.sections || [], lang);
          let corpus = '';

          for (const p of picks) {
            const data = await PlantExplorer.api.getSectionHTML(title, p.index, lang);
            const html = data.parse?.text?.['*'] || '';
            const cleanHtml = stripRefs(html);
            corpus += htmlToText(cleanHtml) + ' ';

            const article = document.createElement('article');
            article.className = "bg-white rounded-2xl shadow p-5";
            article.innerHTML = `<h4 class="font-semibold mb-2">${p.name}</h4><div class="prose max-w-none"></div>`;
            
            // ë³´ì•ˆ: DOMPurifyê°€ ìˆë‹¤ë©´ HTMLì„ ì†Œë…í•˜ì—¬ ì‚½ì…
            if (window.DOMPurify) {
              article.querySelector('.prose').innerHTML = DOMPurify.sanitize(cleanHtml);
            } else {
              article.querySelector('.prose').innerHTML = cleanHtml; // DOMPurifyê°€ ì—†ì„ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚½ì…
            }
            
            article.querySelectorAll('a').forEach(a => a.setAttribute('target', '_blank'));
            secWrap.appendChild(article);
          }
          return corpus;
        },
        addSourcePanel(title, lines) {
            const wrap = PlantExplorer.elements.sourcesWrap;
            const card = document.createElement('div');
            const list = (lines||[]).filter(Boolean).slice(0,8).map(s=>`<li>${s}</li>`).join('');
            card.innerHTML = `<article class="bg-white rounded-2xl shadow p-5"><div class="font-semibold mb-2">${title}</div><ul class="list-disc pl-5 text-slate-700 leading-7">${list||'<li>ì¶”ê°€ ì •ë³´ ì—†ìŒ</li>'}</ul></article>`;
            wrap.appendChild(card.firstElementChild);
        },
        renderFeatures(corpus) {
            const { analyzePlantFeatures, fillList } = PlantExplorer.utils;
            const feats = analyzePlantFeatures(corpus);
            fillList('feat-seed', feats.seed, 'ì”¨ì•—ì˜ ëª¨ì–‘ì„ ê´€ì°°í•´ ê¸°ë¡í•´ ë³´ì„¸ìš”.');
            fillList('feat-root', feats.root, 'ì›ë¿Œë¦¬ì¸ì§€ ìˆ˜ì—¼ë¿Œë¦¬ì¸ì§€ ì‚´í´ë³´ì„¸ìš”.');
            fillList('feat-leaf', feats.leaf, 'ì ë°°ì—´Â·ëª¨ì–‘Â·ê°€ì¥ìë¦¬Â·í¬ê¸°ë¥¼ ê´€ì°°í•´ ë³´ì„¸ìš”.');
            fillList('feat-stem', feats.stem, 'ì¤„ê¸°ì˜ êµµê¸°Â·ë°©í–¥(ì§ë¦½/ë©êµ´)ê³¼ ì„±ì§ˆ(ì´ˆë³¸/ëª©ë³¸)ì„ ì‚´í´ë³´ì„¸ìš”.');
            fillList('feat-flower', feats.flower, 'ê½ƒì˜ ìƒ‰ê³¼ ê½ƒì ìˆ˜, í™”ì„œë¥¼ ì‚´í´ë³´ì„¸ìš”.');
            fillList('feat-bloom', feats.bloom, 'í”¼ëŠ” ê³„ì ˆì´ë‚˜ ë‹¬ì„ ì°¾ì•„ë³´ì„¸ìš”.');
            fillList('feat-fruit', feats.fruit, 'ì—´ë§¤ì˜ í˜•íƒœì™€ ì”¨ì•— í¼ì§ ë°©ë²•ì„ í™•ì¸í•´ ë³´ì„¸ìš”.');
            fillList('feat-pollination', feats.pollination, 'ê³¤ì¶©Â·ë°”ëŒÂ·ìƒˆÂ·ìê°€ ë“± ì–´ë–»ê²Œ ê½ƒê°€ë£¨ê°€ ì˜®ê²¨ê°€ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.');
            this.toggle(PlantExplorer.elements.detailWrap, true);
            return feats;
        },
        renderGrowthInfo(corpus, feats) {
            const { generateElementaryGrowth, buildStageTexts } = PlantExplorer.utils;
            document.getElementById('growthContent').innerHTML = generateElementaryGrowth(corpus, feats);
            const stage = buildStageTexts(feats);
            document.getElementById('stage-germination').textContent = stage.germination;
            document.getElementById('stage-growth').textContent = stage.growth;
            document.getElementById('stage-flowering').textContent = stage.flowering;
            document.getElementById('stage-fruiting').textContent = stage.fruiting;
            this.toggle(PlantExplorer.elements.growthWrap, true);
            this.toggle(PlantExplorer.elements.stageCards, true);
        },
        renderGallery(wikiImages, extImages) {
            const merged = [...wikiImages, ...extImages].slice(0, 20);
            if (merged.length) {
              PlantExplorer.elements.gallery.innerHTML = merged.map(it =>
                `<a href="${it.src}" target="_blank" class="group block overflow-hidden rounded-xl border bg-white">
                  <img src="${it.thumb}" alt="${it.caption||'image'}" class="w-full h-40 object-cover group-hover:scale-105 transition"/>
                  <div class="p-2 text-xs text-slate-600">
                    <div class="truncate">${it.caption || 'ì´ë¯¸ì§€'}</div>
                    <div class="text-[10px] text-slate-400 truncate">${it.credit || ''}</div>
                  </div>
                </a>`
              ).join('');
              this.toggle(PlantExplorer.elements.galleryWrap, true);
            }
        }
      },
      
      // --- ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜ ---
      utils: {
        norm: (s) => (s || '').toLowerCase().replace(/\s+/g, ' ').trim(),
        htmlToText(html) {
          const tmp = document.createElement('div');
          tmp.innerHTML = html;
          return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
        },
        stripRefs: (html) => html.replaceAll(/<sup[^>]*class=\"reference\"[\s\S]*?<\/sup>/g, '').replaceAll(/<table[^>]*class=\"infobox[\s\S]*?<\/table>/g, '').replaceAll(/<style[\s\S]*?<\/style>/g, '').replaceAll(/<script[\s\S]*?<\/script>/g, '').replaceAll(/\s\(\s*í¸ì§‘\s*\)/g, ''),
        bestSearchHit(list, q) {
          if (!Array.isArray(list) || !list.length) return null;
          const lowerQ = q.toLowerCase();
          const exact = list.find(h => (h.title || '').toLowerCase() === lowerQ);
          if (exact) return exact;
          const contains = list.find(h => (h.title || '').toLowerCase().includes(lowerQ));
          if (contains) return contains;
          return list.sort((a, b) => (a.title || '').length - (b.title || '').length)[0];
        },
        pickSectionsByLabels(sections, lang) {
            const labels = (lang === 'ko') ? PlantExplorer.constants.sectionMapKo : PlantExplorer.constants.sectionMapEn;
            const wanted = sections.map(s => {
                const name = s?.line || '';
                return labels.some(l => name.toLowerCase().includes(l.toLowerCase())) ? { index: s.index, name } : null;
            }).filter(Boolean);
            const seen = new Set();
            return wanted.filter(w => {
                const key = w.name.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            }).slice(0, 8);
        },
        analyzePlantFeatures(corpus){
            const t = this.norm(corpus);
            const find = (regex, value) => regex.test(t) ? [value] : [];
            const uniq = (arr) => Array.from(new Set(arr.flat().map(s=>s.trim())));

            return {
                seed: uniq([ ...find(/\b(achene|ìˆ˜ê³¼)\b/, 'ì”¨ì•—: ìˆ˜ê³¼(ì‘ê³  ë§ˆë¥¸ ì”¨)') ]),
                root: uniq([ ...find(/\b(taproot|ì›ë¿Œë¦¬)\b/, 'ì›ë¿Œë¦¬(êµµì€ ë¿Œë¦¬ í•˜ë‚˜)'), ...find(/\b(fibrous\s*root|ìˆ˜ì—¼ë¿Œë¦¬)\b/, 'ìˆ˜ì—¼ë¿Œë¦¬(ê°€ëŠ” ë¿Œë¦¬ ì—¬ëŸ¿)'), ...find(/\b(rhizome|ë•…ì†ì¤„ê¸°)\b/, 'ë•…ì†ì¤„ê¸°ë¡œ ë²ˆì‹'), ...find(/\b(tuber|ë©ì´ì¤„ê¸°)\b/, 'ë©ì´ì¤„ê¸°ì— ì–‘ë¶„ ì €ì¥'), ...find(/\b(bulb|ë¹„ëŠ˜ì¤„ê¸°|ì•Œë¿Œë¦¬)\b/, 'ì•Œë¿Œë¦¬(ë¹„ëŠ˜ì¤„ê¸°)') ]),
                leaf: uniq([ ...find(/\b(opposite|ë§ˆì£¼ë‚˜ê¸°)\b/, 'ì ë°°ì—´: ë§ˆì£¼ë‚˜ê¸°'), ...find(/\b(alternate|ì–´ê¸‹ë‚˜ê¸°)\b/, 'ì ë°°ì—´: ì–´ê¸‹ë‚˜ê¸°'), ...find(/\b(whorled|ëŒë ¤ë‚˜ê¸°)\b/, 'ì ë°°ì—´: ëŒë ¤ë‚˜ê¸°'), ...find(/\b(simple\s*leaf|í™‘ì)\b/, 'ì: í™‘ì'), ...find(/\b(compound\s*leaf|ê²¹ì)\b/, 'ì: ê²¹ì'), ...find(/\b(needle|ë°”ëŠ˜ì)\b/, 'ì ëª¨ì–‘: ë°”ëŠ˜ì'), ...find(/\b(heart\-shaped|cordate|ì‹¬ì¥í˜•)\b/, 'ì ëª¨ì–‘: ì‹¬ì¥í˜•'), ...find(/\b(serrate|í†±ë‹ˆ)\b/, 'ì ê°€ì¥ìë¦¬: í†±ë‹ˆ') ]),
                stem: uniq([ ...find(/\b(woody|ëª©ì§ˆ|tree\s*like|ë‚˜ë¬´ì¤„ê¸°)\b/, 'ì¤„ê¸°: ëª©ì§ˆ(ë‹¨ë‹¨í•¨)'), ...find(/\b(herbaceous|ì´ˆë³¸)\b/, 'ì¤„ê¸°: ì´ˆë³¸(ë¶€ë“œëŸ¬ì›€)'), ...find(/\b(climbing|vine|ë©êµ´|twining)\b/, 'ì¤„ê¸°: ë©êµ´ì„±/ê°ê¹€'), ...find(/\b(thorn|spine|prickle|ê°€ì‹œ)\b/, 'ì¤„ê¸°: ê°€ì‹œ ì¡´ì¬') ]),
                flower: uniq([ ...find(/\b(yellow|ë…¸ë€)\b/, 'ê½ƒ ìƒ‰: ë…¸ë€ìƒ‰'), ...find(/\b(white|í•˜ì–€|í°)\b/, 'ê½ƒ ìƒ‰: í°ìƒ‰'), ...find(/\b(red|ë¶‰|ë¹¨ê°„)\b/, 'ê½ƒ ìƒ‰: ë¹¨ê°„ìƒ‰'), ...find(/\b(pink|ë¶„í™)\b/, 'ê½ƒ ìƒ‰: ë¶„í™ìƒ‰'), ...find(/\b(purple|ë³´ë¼)\b/, 'ê½ƒ ìƒ‰: ë³´ë¼ìƒ‰'), ...find(/\b(blue|íŒŒë€)\b/, 'ê½ƒ ìƒ‰: íŒŒë€ìƒ‰'), ...find(/(\b|\s)(5|ë‹¤ì„¯)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/, 'ê½ƒì ìˆ˜: 5ì¥'), ...find(/\b(inflorescence|í™”ì„œ|head\b|ë‘ìƒí™”ì„œ)/, 'ê½ƒì´ ëª¨ì—¬ í”¼ëŠ” í™”ì„œ') ]),
                bloom: uniq([ ...(t.match(/(\d{1,2})\s*[-~â€“]\s*(\d{1,2})\s*ì›”/) ? [`${t.match(/(\d{1,2})\s*[-~â€“]\s*(\d{1,2})\s*ì›”/)[1]}~${t.match(/(\d{1,2})\s*[-~â€“]\s*(\d{1,2})\s*ì›”/)[2]}ì›” ê°œí™”`] : []), ...find(/\b(ë´„|spring)\b/, 'ë´„ì— í•Œ'), ...find(/\b(ì—¬ë¦„|summer)\b/, 'ì—¬ë¦„ì— í•Œ'), ...find(/\b(ê°€ì„|autumn|fall)\b/, 'ê°€ì„ì— í•Œ') ]),
                fruit: uniq([ ...find(/\b(achene|ìˆ˜ê³¼)\b/, 'ì—´ë§¤: ìˆ˜ê³¼(ë§ˆë¥¸ ì—´ë§¤)'), ...find(/\b(berry|ì¥ê³¼)\b/, 'ì—´ë§¤: ì¥ê³¼(ì¦™ì´ ë§ìŒ)'), ...find(/\b(drupe|í•µê³¼)\b/, 'ì—´ë§¤: í•µê³¼(ë”±ë”±í•œ ì”¨)'), ...find(/\b(capsule|ì‚­ê³¼)\b/, 'ì—´ë§¤: ì‚µê³¼/ì‚­ê³¼(ìµìœ¼ë©´ í„°ì§)'), ...find(/\b(cone|êµ¬ê³¼|strobilus)\b/, 'ì—´ë§¤: êµ¬ê³¼(ì†”ë°©ìš¸)') ]),
                pollination: uniq([ ...find(/\b(insect\s*pollination|ê³¤ì¶©\s*ìˆ˜ë¶„|ë²Œ|ë‚˜ë¹„)\b/, 'ê³¤ì¶© ìˆ˜ë¶„(ë²ŒÂ·ë‚˜ë¹„ ë“±)'), ...find(/\b(wind\s*pollination|í’ë§¤|ë°”ëŒ\s*ìˆ˜ë¶„)\b/, 'ë°”ëŒ(í’ë§¤) ìˆ˜ë¶„'), ...find(/\b(bird\s*pollination|ì¡°ë§¤|ìƒˆ\s*ìˆ˜ë¶„)\b/, 'ìƒˆ(ì¡°ë§¤) ìˆ˜ë¶„'), ...find(/\b(self\s*pollination|ìê°€\s*ìˆ˜ë¶„)\b/, 'ìê°€ ìˆ˜ë¶„') ]),
            };
        },
        generateElementaryGrowth(corpus, feats){
            const hasTap = feats.root.includes('ì›ë¿Œë¦¬(êµµì€ ë¿Œë¦¬ í•˜ë‚˜)');
            const hasFib = feats.root.includes('ìˆ˜ì—¼ë¿Œë¦¬(ê°€ëŠ” ë¿Œë¦¬ ì—¬ëŸ¿)');
            const poll = feats.pollination[0] || 'ìˆ˜ë¶„(ê½ƒê°€ë£¨ë°›ì´)';
            const bloomHint = feats.bloom[0] || 'ì•Œë§ì€ ê³„ì ˆì—';
            const fruitHint = feats.fruit[0] || 'ì—´ë§¤ê°€ ìë¼ ì”¨ì•—ì„ ë³´í˜¸';

            const lines = [
                'â‘  ì”¨ì•—ì´ ë¬¼ì„ ë¹¨ì•„ë“¤ì—¬ ê»ì§ˆì´ ë¶€ë“œëŸ¬ì›Œì§€ë©´ ì‘ì€ ë¿Œë¦¬ì™€ ì‹¹ì´ ë‚˜ì™€ìš”.',
                hasTap ? 'â‘¡ êµµì€ ì›ë¿Œë¦¬ê°€ ì•„ë˜ë¡œ ê¸¸ê²Œ ìë¼ê³  ì¤„ê¸°ê°€ ìœ„ë¡œ ìë¼ìš”.' : hasFib ? 'â‘¡ ì—¬ëŸ¬ ê°ˆë˜ì˜ ìˆ˜ì—¼ë¿Œë¦¬ê°€ ì‚¬ë°©ìœ¼ë¡œ í¼ì§€ê³  ì¤„ê¸°ê°€ ì ì  ê¸¸ì–´ì ¸ìš”.' : 'â‘¡ ë¿Œë¦¬Â·ì¤„ê¸°Â·ìì´ ì»¤ì§€ë©° í–‡ë¹›ì„ ë°›ì•„ ì—ë„ˆì§€ë¥¼ ë§Œë“¤ì–´ìš”.',
                'â‘¢ ìì´ ë„“ê²Œ í¼ì³ì§€ê³  ì¤„ê¸°ê°€ íŠ¼íŠ¼í•´ì ¸ ìŠ¤ìŠ¤ë¡œ ì„œ ìˆì„ ìˆ˜ ìˆì–´ìš”.',
                `â‘£ ${bloomHint} ê½ƒì´ í”¼ê³ , ${poll}ê°€ ì¼ì–´ë‚˜ ì”¨ë°© ì†ì— ì”¨ê°€ ë§Œë“¤ì–´ì ¸ìš”.`,
                `â‘¤ ${fruitHint}í•˜ê³ , ìµì€ ì”¨ì•—ì´ ë°”ëŒÂ·ë™ë¬¼Â·ì‚¬ëŒ ë“±ì— ì˜í•´ ë„ë¦¬ í¼ì ¸ìš”.`
            ];
            return `<ul class="list-disc pl-5">${lines.map(s=>`<li>${s}</li>`).join('')}</ul>`;
        },
        buildStageTexts(feats){
            const pick2 = (arr)=> arr.slice(0,2).join(' Â· ');
            const seedTxt = feats.seed[0] || 'ì”¨ì•—ì´ ë¬¼ì„ ë§Œë‚˜ ì‹¹ì´ ë‚˜ì™€ìš”.';
            const rootTxt = feats.root[0] || 'ë¿Œë¦¬ê°€ ìë¼ í™ì— ë‹¨ë‹¨íˆ ê³ ì •ë¼ìš”.';
            const stemTxt = feats.stem[0] || 'ì¤„ê¸°ê°€ ìë¼ë©° ì‹ë¬¼ì„ ì§€íƒ±í•´ìš”.';
            const leafTxt = pick2(feats.leaf.filter(x=>/ì/.test(x))) || 'ìì´ í¼ì³ì ¸ í–‡ë¹›ì„ ë°›ì•„ìš”.';
            const flowerTxt = pick2(feats.flower.filter(x=>x.startsWith('ê½ƒ '))) || 'ë‹¤ì–‘í•œ ìƒ‰ì˜ ê½ƒì´ í”¼ì–´ìš”';
            const pollTxt = feats.pollination[0] ? `, ${feats.pollination[0]}ë¡œ` : '';
            const bloomTxt = feats.bloom[0] ? ` (${feats.bloom[0]})` : '';
            const fruitTxt = feats.fruit[0] || 'ì—´ë§¤ê°€ ìë¼ ì”¨ì•—ì„ ë³´í˜¸í•´ìš”.';
            return {
                germination: `${seedTxt} ${rootTxt}`,
                growth: `${stemTxt} ${leafTxt}`,
                flowering: `${flowerTxt}${bloomTxt}${pollTxt} ìˆ˜ë¶„ì´ ì¼ì–´ë‚˜ìš”.`,
                fruiting: `${fruitTxt} ìµìœ¼ë©´ ì”¨ì•—ì´ í¼ì ¸ ë‹¤ìŒ í•´ì— ìƒˆ ì‹ë¬¼ì´ ìë¼ìš”.`
            };
        },
        fillList(id, arr, fallback){
            const uniqArr = [...new Set(arr)];
            const el = document.getElementById(id);
            el.innerHTML = (uniqArr.length ? uniqArr : [fallback]).map(s=>`<li>${s}</li>`).join('');
        },
      },
      
      // --- ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜ ---
      async run(query, lang) {
        try {
          this.ui.resetUI();

          // 1. ìœ„í‚¤í”¼ë””ì•„ ê²€ìƒ‰ì–´ ê²°ì •
          const pick = await this.api.searchTitle(query, lang);
          if (!pick) {
            this.ui.setStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì´ë‚˜ í•™ëª…ìœ¼ë¡œ ì‹œë„í•´ ë³´ì„¸ìš”.');
            this.ui.toast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          const { title, lang: usedLang } = pick;
          
          // 2. ìœ„í‚¤í”¼ë””ì•„ ê¸°ë³¸ ì •ë³´ ë° ì„¹ì…˜ ë Œë”ë§
          const summary = await this.api.getSummary(title, usedLang);
          this.ui.renderSummary(summary, usedLang);
          
          const sectionsData = await this.api.getSections(title, usedLang);
          let corpus = summary.extract || '';
          corpus += await this.ui.renderSections(title, sectionsData, usedLang);

          // 3. ì™¸ë¶€ ë°ì´í„° ë³‘ë ¬ í˜¸ì¶œ
          const proxy = document.getElementById('proxyURL').value.trim();
          const promises = [];
          
          promises.push(this.api.getMediaList(title, usedLang)); // Wiki Media
          if (document.getElementById('optGBIF').checked) promises.push(this.api.fetchGBIF(title));
          if (document.getElementById('optEOL').checked) promises.push(this.api.fetchEOL(title, proxy));
          if (document.getElementById('optINat').checked) promises.push(this.api.fetchINat(title));
          if (document.getElementById('optNIBR').checked) promises.push(this.api.fetchProxyText('https://species.nibr.go.kr/', proxy).then(text => ({type: 'nibr', text})));
          if (document.getElementById('optKoagi').checked) promises.push(this.api.fetchProxyText('https://garden.koagi.or.kr/', proxy).then(text => ({type: 'koagi', text})));

          const results = await Promise.allSettled(promises);
          
          // 4. ë³‘ë ¬ í˜¸ì¶œ ê²°ê³¼ ì²˜ë¦¬
          let extImages = [];
          const [wikiMediaResult, ...otherResults] = results;

          otherResults.forEach(res => {
            if (res.status === 'fulfilled' && res.value) {
                const data = res.value;
                corpus += data.text || '';
                if(data.images) extImages.push(...data.images);
                if(data.type === 'gbif') this.ui.addSourcePanel('GBIF ë¶„ë¥˜ ìš”ì•½', data.text.split(' Â· '));
                if(data.type === 'eol') this.ui.addSourcePanel('EOL ìš”ì•½', (data.text || '').split(/[ã€‚.\.!?]/).map(s => s.trim()).filter(s => s).slice(0, 6));
                if(data.type === 'nibr') this.ui.addSourcePanel('êµ­ë¦½ìƒë¬¼ìì›ê´€', ['êµ­ë‚´ í‘œì¤€ ë„ê° í…ìŠ¤íŠ¸ ë³´ê°•']);
                if(data.type === 'koagi') this.ui.addSourcePanel('KoAGI ì •ì›ì‹ë¬¼ì •ë³´', ['ì •ì›ì‹ë¬¼ ì •ë³´ ë³´ê°•']);
            }
          });
          
          if(results.some(res => res.status === 'fulfilled' && res.value.type === 'inat')) {
            this.ui.addSourcePanel('iNaturalist', ['ì‹¤ì œ ê´€ì°° ì‚¬ì§„ì´ ê°¤ëŸ¬ë¦¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.']);
          }

          // 5. íŠ¹ì§• ì¶”ì¶œ ë° í•œì‚´ì´ ì •ë³´ ë Œë”ë§
          const feats = this.ui.renderFeatures(corpus);
          this.ui.renderGrowthInfo(corpus, feats);
          
          // 6. ê°¤ëŸ¬ë¦¬ ë Œë”ë§
          const wikiImages = (wikiMediaResult.status === 'fulfilled' ? wikiMediaResult.value.items : [])
            .filter(x => x.type === 'image' || x.type === 'mediainfo')
            .map(item => {
              const thumb = item?.thumbnail?.source || item?.srcset?.[0]?.src;
              return { thumb, src: item?.original?.source || thumb, caption: item?.title || item?.caption?.text || '', credit: item?.artist?.text || item?.credit || 'Wikipedia' };
            });
            
          this.ui.renderGallery(wikiImages, extImages);
          
          this.ui.setStatus('');

        } catch (e) {
          console.error(e);
          this.ui.setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.');
          this.ui.toast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬/CORS ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        }
      },

      // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™” ---
      init() {
        document.getElementById('searchBtn').addEventListener('click', () => {
          const query = document.getElementById('q').value.trim() || 'í•´ë°”ë¼ê¸°';
          const lang = document.getElementById('lang').value;
          this.run(query, lang);
        });
        document.getElementById('q').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') document.getElementById('searchBtn').click();
        });
        document.getElementById('printBtn').addEventListener('click', () => window.print());
        document.getElementById('proxyTest').addEventListener('click', async () => {
          const proxyURL = document.getElementById('proxyURL').value.trim();
          try {
            await fetch(`${proxyURL}https://example.org/`);
            this.ui.toast('í”„ë¡ì‹œ ì—°ê²° ì„±ê³µ');
          } catch {
            this.ui.toast('í”„ë¡ì‹œ ì—°ê²° ì‹¤íŒ¨: ì£¼ì†Œë¥¼ ë°”ê¿” ë³´ì„¸ìš”');
          }
        });
        window.addEventListener('DOMContentLoaded', () => this.run('í•´ë°”ë¼ê¸°', 'ko'));
      }
    };

    PlantExplorer.init();
  </script>
</body>
</html>
