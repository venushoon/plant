<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì‹ë¬¼ í•œì‚´ì´ íƒêµ¬ (Wikipedia ì „ìš© Â· íŠ¹ì§•â†’ë‹¨ê³„ ë°˜ì˜)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .prose :where(p,li){line-height:1.8}
    @media print {
      .no-print { display: none !important; }
      .print-grid { grid-template-columns: 1fr 1fr; gap: 16px; }
      a::after { content: " (ë§í¬)"; font-size: 10px; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <header class="bg-white sticky top-0 z-10 border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-green-600">
        <path d="M12 2a7 7 0 00-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
      </svg>
      <div>
        <h1 class="text-xl font-bold">ì‹ë¬¼ í•œì‚´ì´ íƒêµ¬ (Wikipedia)</h1>
        <p class="text-sm text-slate-500">ë°œì•„Â·ì„±ì¥Â·ê°œí™”Â·ê²°ì‹¤ + ì„¸ë¶€ íŠ¹ì§• â†’ ë‹¨ê³„ ì¹´ë“œ ìë™ ë°˜ì˜</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="printBtn" class="no-print rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50 transition">ì¸ì‡„/ë°°í¬</button>
        <div class="text-xs text-slate-400">Â© Wikipedia/Wikimedia</div>
      </div>
    </div>
  </header>

  <section class="max-w-6xl mx-auto px-4 py-4">
    <div class="bg-white rounded-2xl shadow p-4 flex flex-col md:flex-row gap-3 items-stretch md:items-center">
      <div class="flex-1 flex gap-2">
        <input id="q" class="w-full rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ì˜ˆ: í•´ë°”ë¼ê¸°, ë²šë‚˜ë¬´, ì†Œë‚˜ë¬´ ..." />
        <select id="lang" class="rounded-xl border px-3 py-3">
          <option value="ko" selected>í•œêµ­ì–´(ko)</option>
          <option value="en">English(en)</option>
        </select>
      </div>
      <div class="flex gap-2">
        <button id="searchBtn" class="rounded-xl bg-green-600 text-white px-5 py-3 font-semibold hover:bg-green-700 transition">ê²€ìƒ‰</button>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">â€» í•œêµ­ì–´ ë¬¸ì„œê°€ ë¶€ì¡±í•  ê²½ìš° ì˜ì–´ ë¬¸ì„œë¡œ ìë™ ë³´ì™„ ê²€ìƒ‰í•©ë‹ˆë‹¤.</p>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <div id="toast" class="hidden mx-auto max-w-3xl mb-4 rounded-xl bg-amber-50 text-amber-800 border border-amber-200 px-4 py-3"></div>

    <!-- ìš”ì•½ -->
    <section id="summary" class="hidden bg-white rounded-2xl shadow overflow-hidden">
      <div class="md:flex">
        <div class="md:w-1/3">
          <img id="thumb" class="w-full h-64 object-cover" alt="ëŒ€í‘œ ì´ë¯¸ì§€" />
        </div>
        <div class="p-6 md:w-2/3">
          <div class="flex items-start gap-2">
            <h2 id="title" class="text-2xl font-bold"></h2>
            <a id="wikiLink" href="#" target="_blank" class="ml-auto text-green-600 text-sm underline">ìœ„í‚¤ ì›ë¬¸</a>
          </div>
          <p id="extract" class="mt-3 text-slate-700 leading-7"></p>
          <div id="meta" class="mt-3 text-xs text-slate-500"></div>
        </div>
      </div>
    </section>

    <!-- ìœ„í‚¤ ì„¹ì…˜ë“¤ -->
    <section id="sections" class="mt-6 grid lg:grid-cols-3 gap-6 print-grid"></section>

    <!-- í•œì‚´ì´ ìš”ì•½ (ì´ˆë“± ëˆˆë†’ì´ Â· ê°•í™”) -->
    <section id="growthWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">í•œì‚´ì´ ê³¼ì • ìš”ì•½ (ì´ˆë“± ëˆˆë†’ì´)</h3>
      <div id="growthContent" class="bg-white rounded-2xl shadow p-5 text-slate-700 leading-7"></div>
    </section>

    <!-- ë‹¨ê³„ ì¹´ë“œ -->
    <section id="stageCards" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ë°œì•„ â†’ ì„±ì¥ â†’ ê°œí™” â†’ ê²°ì‹¤ (ì„¸ë¶€íŠ¹ì§• ë°˜ì˜)</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ±</div>
          <div class="mt-2 font-semibold">ë°œì•„</div>
          <p id="stage-germination" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ¿</div>
          <div class="mt-2 font-semibold">ì„±ì¥</div>
          <p id="stage-growth" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸŒ¼</div>
          <div class="mt-2 font-semibold">ê°œí™”</div>
          <p id="stage-flowering" class="text-sm text-slate-600 mt-1"></p>
        </article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center">
          <div class="text-4xl">ğŸ</div>
          <div class="mt-2 font-semibold">ê²°ì‹¤</div>
          <p id="stage-fruiting" class="text-sm text-slate-600 mt-1"></p>
        </article>
      </div>
    </section>

    <!-- ì„¸ë¶€ íŠ¹ì§• ì¹´ë“œ ë¬¶ìŒ (ì¤‘ë³µ ì œê±° ë° ìë™ ì¶”ì • ê°•í™”) -->
    <section id="detailWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ì„¸ë¶€ íŠ¹ì§•</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ°</span><h4 class="font-semibold">ì”¨ì•—ì˜ ìƒê¹€ìƒˆ</h4></div><ul id="feat-seed" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ«š</span><h4 class="font-semibold">ë¿Œë¦¬ì˜ ëª¨ì–‘</h4></div><ul id="feat-root" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸƒ</span><h4 class="font-semibold">ìì˜ íŠ¹ì§•</h4></div><ul id="feat-leaf" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ¿</span><h4 class="font-semibold">ì¤„ê¸°ì˜ íŠ¹ì§•</h4></div><ul id="feat-stem" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸŒ¼</span><h4 class="font-semibold">ê½ƒì˜ íŠ¹ì§•</h4></div><ul id="feat-flower" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ“…</span><h4 class="font-semibold">í”¼ëŠ” ì‹œê¸°</h4></div><ul id="feat-bloom" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸ</span><h4 class="font-semibold">ì—´ë§¤ì˜ ëª¨ì–‘Â·íŠ¹ì§•</h4></div><ul id="feat-fruit" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5 md:col-span-3"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">ğŸª¶</span><h4 class="font-semibold">ìˆ˜ë¶„ ë°©ë²•(ê½ƒê°€ë£¨ë°›ì´)</h4></div><ul id="feat-pollination" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
      </div>
    </section>

    <!-- ê°¤ëŸ¬ë¦¬ -->
    <section id="galleryWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">ê´€ë ¨ ì‚¬ì§„Â·ì´ë¯¸ì§€</h3>
      <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
      <p class="text-xs text-slate-500 mt-2">ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ì›ë³¸ê³¼ ë¼ì´ì„ ìŠ¤ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </section>

    <div id="status" class="mt-8 text-center text-slate-500"></div>
  </main>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const statusEl = $('#status');
    const toast = (msg)=>{ const t=document.getElementById('toast'); t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2500); };

    const sectionMapKo = [ 'ë°œì•„','ìƒì¥','ê°œí™”','ìˆ˜ë¶„','ìˆ˜ì •','ê²°ì‹¤','ì”¨ì•—','ì—´ë§¤','ë²ˆì‹','í˜•íƒœ','íŠ¹ì§•','ìƒíƒœ','ì„œì‹','ë¶„í¬' ];
    const sectionMapEn = [ 'Germination','Growth','Flowering','Pollination','Fertilization','Fruit','Seed','Reproduction','Characteristics','Description','Ecology','Habitat','Distribution' ];

    const aliasMap = { 'í•´ë°”ë¼ê¸°': 'Sunflower','ë²šë‚˜ë¬´': 'Prunus serrulata','ì†Œë‚˜ë¬´': 'Pine','ì¥ë¯¸': 'Rose','íŠ¤ë¦½': 'Tulip','ë¯¼ë“¤ë ˆ':'Taraxacum','ë¬´ê¶í™”':'Hibiscus syriacus' };

    function apiURL(lang, path) { return `https://${lang}.wikipedia.org${path}`; }
    const norm = (s)=> (s||'').toLowerCase().replace(/\s+/g,' ').trim();

    function setStatus(msg) { statusEl.textContent = msg || ''; }
    function show(el) { el.classList.remove('hidden'); }
    function hide(el) { el.classList.add('hidden'); }

    function bestSearchHit(list, q){ if(!Array.isArray(list) || !list.length) return null; const lowerQ = q.toLowerCase(); const exact = list.find(h => (h.title||'').toLowerCase() === lowerQ); if (exact) return exact; const contains = list.find(h => (h.title||'').toLowerCase().includes(lowerQ)); if (contains) return contains; return list.sort((a,b)=> (a.title||'').length - (b.title||'').length)[0]; }

    async function searchTitleRaw(query, lang){ const url = apiURL(lang, `/w/api.php?action=query&list=search&srnamespace=0&srsearch=${encodeURIComponent(query)}&format=json&origin=*`); const r = await fetch(url); if(!r.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨'); return (await r.json())?.query?.search || []; }

    async function searchTitle(query, lang){
      let hits = await searchTitleRaw(query, lang);
      let pick = bestSearchHit(hits, query);
      if (pick) return { title: pick.title, lang };
      if (lang==='ko' && aliasMap[query]){
        hits = await searchTitleRaw(aliasMap[query], 'en'); pick = bestSearchHit(hits, aliasMap[query]); if (pick) return { title: pick.title, lang: 'en' };
      }
      if (lang==='ko'){
        hits = await searchTitleRaw(query, 'en'); pick = bestSearchHit(hits, query); if (pick) return { title: pick.title, lang: 'en' };
      }
      return null;
    }

    async function getSummary(title, lang) { const url = apiURL(lang, `/api/rest_v1/page/summary/${encodeURIComponent(title)}`); const r = await fetch(url); if (!r.ok) throw new Error('ìš”ì•½ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return r.json(); }
    async function getSections(title, lang) { const url = apiURL(lang, `/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=sections&format=json&origin=*`); const r = await fetch(url); const j = await r.json(); return j?.parse?.sections || []; }
    async function getSectionHTML(title, index, lang) { const url = apiURL(lang, `/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=text&section=${index}&format=json&origin=*`); const r = await fetch(url); const j = await r.json(); return j?.parse?.text?.['*'] || ''; }
    async function getMediaList(title, lang) { const url = apiURL(lang, `/api/rest_v1/page/media-list/${encodeURIComponent(title)}`); const r = await fetch(url); if (!r.ok) return { items: [] }; return r.json(); }

    function pickSectionsByLabels(sections, lang) { const labels = (lang === 'ko') ? sectionMapKo : sectionMapEn; const wanted = []; for (const s of sections) { const name = s?.line || ''; if (labels.some(l => name.toLowerCase().includes(l.toLowerCase()))) wanted.push({ index: s.index, name }); } const seen = new Set(); return wanted.filter(w => { const key = w.name.toLowerCase(); if (seen.has(key)) return false; seen.add(key); return true; }).slice(0, 8); }

    function stripRefs(html) { return html.replaceAll(/<sup[^>]*class=\"reference\"[\s\S]*?<\/sup>/g, '').replaceAll(/<table[^>]*class=\"infobox[\s\S]*?<\/table>/g, '').replaceAll(/<style[\s\S]*?<\/style>/g, '').replaceAll(/<script[\s\S]*?<\/script>/g, '').replaceAll(/\s\(\s*í¸ì§‘\s*\)/g, ''); }
    function htmlToText(html){ const tmp=document.createElement('div'); tmp.innerHTML=html; return (tmp.textContent||tmp.innerText||'').replace(/\s+/g,' ').trim(); }

    // === íŠ¹ì§• ìë™ ì¶”ì¶œ (ì¤‘ë³µ ì œê±° & í™•ì¥ ê·œì¹™) ===
    function analyzePlantFeatures(corpus){
      const t = norm(corpus);
      let seed=[], root=[], leaf=[], stem=[], flower=[], bloom=[], fruit=[], pollination=[];

      // ì—´ë§¤/ì”¨ì•— ìœ í˜•
      if(/\b(achene|ìˆ˜ê³¼)\b/.test(t)) { seed.push('ì”¨ì•—: ìˆ˜ê³¼(ì‘ê³  ë§ˆë¥¸ ì”¨)'); fruit.push('ì—´ë§¤: ìˆ˜ê³¼(ë§ˆë¥¸ ì—´ë§¤)'); }
      if(/\b(berry|ì¥ê³¼)\b/.test(t)) fruit.push('ì—´ë§¤: ì¥ê³¼(ì¦™ì´ ë§ìŒ)');
      if(/\b(drupe|í•µê³¼)\b/.test(t)) fruit.push('ì—´ë§¤: í•µê³¼(ë”±ë”±í•œ ì”¨)');
      if(/\b(capsule|ì‚­ê³¼)\b/.test(t)) fruit.push('ì—´ë§¤: ì‚­ê³¼(ìµìœ¼ë©´ í„°ì§)');
      if(/\b(samara|ë‚ ê°œ\s*ë‹¬ë¦°\s*ì—´ë§¤)\b/.test(t)) fruit.push('ì—´ë§¤: ë‚ ê°œ ë‹¬ë¦¼(ë°”ëŒìœ¼ë¡œ ì´ë™)');
      if(/\b(cone|êµ¬ê³¼|strobilus)\b/.test(t)) fruit.push('ì—´ë§¤: êµ¬ê³¼(ì†”ë°©ìš¸ í˜•íƒœ)');

      // ë¿Œë¦¬
      if(/\b(taproot|ì›ë¿Œë¦¬)\b/.test(t)) root.push('ì›ë¿Œë¦¬(êµµì€ ë¿Œë¦¬ í•˜ë‚˜)');
      if(/\b(fibrous\s*root|ìˆ˜ì—¼ë¿Œë¦¬)\b/.test(t)) root.push('ìˆ˜ì—¼ë¿Œë¦¬(ê°€ëŠ” ë¿Œë¦¬ ì—¬ëŸ¿)');
      if(/\b(rhizome|ë•…ì†ì¤„ê¸°)\b/.test(t)) { root.push('ë•…ì†ì¤„ê¸°ë¡œ ë²ˆì‹'); stem.push('ë•…ì†ì¤„ê¸° ì¡´ì¬'); }
      if(/\b(tuber|ë©ì´ì¤„ê¸°)\b/.test(t)) { root.push('ë©ì´ì¤„ê¸°ì— ì–‘ë¶„ ì €ì¥'); stem.push('ë©ì´ì¤„ê¸°(ì¤„ê¸° ë¹„ëŒ€)'); }
      if(/\b(bulb|ë¹„ëŠ˜ì¤„ê¸°|ì•Œë¿Œë¦¬)\b/.test(t)) { root.push('ì•Œë¿Œë¦¬(ë¹„ëŠ˜ì¤„ê¸°)'); stem.push('ë¹„ëŠ˜ì¤„ê¸°(ì•Œë¿Œë¦¬)'); }

      // ì¤„ê¸° (í˜•íƒœ/ì„±ì§ˆ/ë°©í–¥)
      if(/\b(woody|ëª©ì§ˆ|tree\s*like|ë‚˜ë¬´ì¤„ê¸°)\b/.test(t)) stem.push('ì¤„ê¸°: ëª©ì§ˆ(ë‚˜ë¬´ì²˜ëŸ¼ ë‹¨ë‹¨í•¨)');
      if(/\b(herbaceous|ì´ˆë³¸)\b/.test(t)) stem.push('ì¤„ê¸°: ì´ˆë³¸(ë¶€ë“œëŸ½ê³  í’€ì´ë“¯)');
      if(/\b(succulent|ë‹¤ìœ¡ì§ˆ)\b/.test(t)) stem.push('ì¤„ê¸°: ë‹¤ìœ¡ì§ˆ(ë¬¼ ì €ì¥)');
      if(/\b(climbing|vine|ë©êµ´|twining)\b/.test(t)) stem.push('ì¤„ê¸°: ë©êµ´ì„±/ê°ê¹€');
      if(/\b(erect|ì§ë¦½)\b/.test(t)) stem.push('ì¤„ê¸°: ì§ë¦½');
      if(/\b(prostrate|í¬ë³µ)\b/.test(t)) stem.push('ì¤„ê¸°: ë•…ì„ ê¸°ì–´ ê°(í¬ë³µ)');
      if(/\b(hollow\s*stem|ì†ì´\s*ë¹ˆ\s*ì¤„ê¸°)\b/.test(t)) stem.push('ì¤„ê¸°: ì†ì´ ë¹„ì–´ ìˆìŒ');
      if(/\b(square\s*stem|ë„¤ëª¨ì§„\s*ì¤„ê¸°)\b/.test(t)) stem.push('ì¤„ê¸°: ë„¤ëª¨ì§„ ë‹¨ë©´');
      if(/\b(thorn|spine|prickle|ê°€ì‹œ)\b/.test(t)) stem.push('ì¤„ê¸°: ê°€ì‹œ ì¡´ì¬');

      // ì ë°°ì—´/ëª¨ì–‘/ê°€ì¥ìë¦¬/í¬ê¸°
      if(/\b(opposite|ë§ˆì£¼ë‚˜ê¸°)\b/.test(t)) leaf.push('ì ë°°ì—´: ë§ˆì£¼ë‚˜ê¸°');
      if(/\b(alternate|ì–´ê¸‹ë‚˜ê¸°)\b/.test(t)) leaf.push('ì ë°°ì—´: ì–´ê¸‹ë‚˜ê¸°');
      if(/\b(whorled|ëŒë ¤ë‚˜ê¸°)\b/.test(t)) leaf.push('ì ë°°ì—´: ëŒë ¤ë‚˜ê¸°');
      if(/\b(simple\s*leaf|í™‘ì)\b/.test(t)) leaf.push('ì: í™‘ì');
      if(/\b(compound\s*leaf|ê²¹ì)\b/.test(t)) leaf.push('ì: ê²¹ì');
      if(/\b(needle|ë°”ëŠ˜ì)\b/.test(t)) leaf.push('ì ëª¨ì–‘: ë°”ëŠ˜ì');
      if(/\b(broadleaf|ë„“ì€ì)\b/.test(t)) leaf.push('ì ëª¨ì–‘: ë„“ì€ì');
      if(/\b(linear|ì„ í˜•)\b/.test(t)) leaf.push('ì ëª¨ì–‘: ì„ í˜•');
      if(/\b(ovate|ë‚œí˜•)\b/.test(t)) leaf.push('ì ëª¨ì–‘: ë‚œí˜•');
      if(/\b(elliptic|íƒ€ì›í˜•)\b/.test(t)) leaf.push('ì ëª¨ì–‘: íƒ€ì›í˜•');
      if(/\b(heart\-shaped|cordate|ì‹¬ì¥í˜•)\b/.test(t)) leaf.push('ì ëª¨ì–‘: ì‹¬ì¥í˜•');
      if(/\b(entire\s*margin|ì „ì—°)\b/.test(t)) leaf.push('ì ê°€ì¥ìë¦¬: ì „ì—°(ë§¤ëˆ)');
      if(/\b(serrate|í†±ë‹ˆ(ë¬´ëŠ¬)?)\b/.test(t)) leaf.push('ì ê°€ì¥ìë¦¬: í†±ë‹ˆ');
      if(/\b(dentate|ì¹˜ì•„ìƒ)\b/.test(t)) leaf.push('ì ê°€ì¥ìë¦¬: ì¹˜ì•„ìƒ');
      if(/\b(lobed|ê°ˆë¼ì§|ì‹¬ì—´)\b/.test(t)) leaf.push('ì ê°€ì¥ìë¦¬: ê°ˆë¼ì§');
      if(/\b(small\s*leaves|ì‘ì€\s*ì|minute\s*leaves)\b/.test(t)) leaf.push('ì í¬ê¸°: ì‘ìŒ');
      if(/\b(large\s*leaves|í°\s*ì)\b/.test(t)) leaf.push('ì í¬ê¸°: í¼');

      // ê½ƒ ìƒ‰/ê½ƒì ìˆ˜/í™”ì„œ
      if(/\b(yellow|ë…¸ë€)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: ë…¸ë€ìƒ‰');
      if(/\b(white|í•˜ì–€|í°)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: í°ìƒ‰');
      if(/\b(red|ë¶‰|ë¹¨ê°„)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: ë¹¨ê°„ìƒ‰');
      if(/\b(pink|ë¶„í™)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: ë¶„í™ìƒ‰');
      if(/\b(purple|ë³´ë¼)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: ë³´ë¼ìƒ‰');
      if(/\b(blue|íŒŒë€)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: íŒŒë€ìƒ‰');
      if(/\b(orange|ì£¼í™©)\b/.test(t)) flower.push('ê½ƒ ìƒ‰: ì£¼í™©ìƒ‰');
      if(/(\b|\s)(10|ì—´)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: ~10ì¥');
      if(/(\b|\s)(8|ì—¬ëŸ)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: 8ì¥');
      if(/(\b|\s)(6|ì—¬ì„¯)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: 6ì¥');
      if(/(\b|\s)(5|ë‹¤ì„¯)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: 5ì¥');
      if(/(\b|\s)(4|ë„¤)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: 4ì¥');
      if(/(\b|\s)(3|ì„¸)\s*(petals?|ì¥ì˜?\s*ê½ƒì)/.test(t)) flower.push('ê½ƒì ìˆ˜: 3ì¥');
      if(/\b(inflorescence|í™”ì„œ|head\b|ë‘ìƒí™”ì„œ|raceme|panicle|spike|umbel)\b/.test(t)) flower.push('ê½ƒì´ ëª¨ì—¬ í”¼ëŠ” í™”ì„œ');

      // í”¼ëŠ” ì‹œê¸°
      const monthRange = t.match(/(\d{1,2})\s*[-~â€“]\s*(\d{1,2})\s*ì›”/);
      if(monthRange){ bloom.push(`${monthRange[1]}~${monthRange[2]}ì›” ê°œí™”`); }
      if(/\b(ë´„|spring)\b/.test(t)) bloom.push('ë´„ì— í•Œ');
      if(/\b(ì—¬ë¦„|summer)\b/.test(t)) bloom.push('ì—¬ë¦„ì— í•Œ');
      if(/\b(ê°€ì„|autumn|fall)\b/.test(t)) bloom.push('ê°€ì„ì— í•Œ');
      if(/\b(ê²¨ìš¸|winter)\b/.test(t)) bloom.push('ê²¨ìš¸ì— í•Œ');

      // ìˆ˜ë¶„ ë°©ë²•
      if(/\b(insect\s*pollination|ê³¤ì¶©\s*ìˆ˜ë¶„|ë²Œ|ë‚˜ë¹„)\b/.test(t)) pollination.push('ê³¤ì¶© ìˆ˜ë¶„(ë²ŒÂ·ë‚˜ë¹„ ë“±)');
      if(/\b(wind\s*pollination|í’ë§¤|ë°”ëŒ\s*ìˆ˜ë¶„)\b/.test(t)) pollination.push('ë°”ëŒ(í’ë§¤) ìˆ˜ë¶„');
      if(/\b(bird\s*pollination|ì¡°ë§¤|ìƒˆ\s*ìˆ˜ë¶„|ë²Œìƒˆ)\b/.test(t)) pollination.push('ìƒˆ(ì¡°ë§¤) ìˆ˜ë¶„');
      if(/\b(bat\s*pollination|ë°•ì¥)\b/.test(t)) pollination.push('ë°•ì¥ ìˆ˜ë¶„');
      if(/\b(self\s*pollination|ìê°€\s*ìˆ˜ë¶„)\b/.test(t)) pollination.push('ìê°€ ìˆ˜ë¶„');
      if(/\b(water\s*pollination|ìˆ˜ë§¤)\b/.test(t)) pollination.push('ë¬¼(ìˆ˜ë§¤) ìˆ˜ë¶„');

      const uniq = (arr)=> Array.from(new Set(arr.map(s=>s.replace(/\s+/g,' ').trim())));
      return { seed:uniq(seed), root:uniq(root), leaf:uniq(leaf), stem:uniq(stem), flower:uniq(flower), bloom:uniq(bloom), fruit:uniq(fruit), pollination:uniq(pollination) };
    }

    // === í•œì‚´ì´ ìš”ì•½(ì´ˆë“±) Â· ì„¸ë¶€ ë‹¨ê³„ ë¬¸êµ¬ ìƒì„± ===
    function generateElementaryGrowth(corpus, feats){
      const hasTap = feats.root.includes('ì›ë¿Œë¦¬(êµµì€ ë¿Œë¦¬ í•˜ë‚˜)');
      const hasFib = feats.root.includes('ìˆ˜ì—¼ë¿Œë¦¬(ê°€ëŠ” ë¿Œë¦¬ ì—¬ëŸ¿)');
      const poll = feats.pollination[0] || 'ìˆ˜ë¶„(ê½ƒê°€ë£¨ë°›ì´)';
      const bloomHint = feats.bloom[0] || 'ì•Œë§ì€ ê³„ì ˆì—';
      const fruitHint = feats.fruit[0] || 'ì—´ë§¤ê°€ ìë¼ ì”¨ì•—ì„ ë³´í˜¸';

      const lines = [
        'â‘  ì”¨ì•—ì´ ë¬¼ì„ ë¹¨ì•„ë“¤ì—¬ ê»ì§ˆì´ ë¶€ë“œëŸ¬ì›Œì§€ë©´ ì‘ì€ ë¿Œë¦¬ì™€ ì‹¹ì´ ë‚˜ì™€ìš”.',
        hasTap ? 'â‘¡ êµµì€ ì›ë¿Œë¦¬ê°€ ì•„ë˜ë¡œ ê¸¸ê²Œ ìë¼ê³  ì¤„ê¸°ê°€ ìœ„ë¡œ ìë¼ìš”.' : hasFib ? 'â‘¡ ì—¬ëŸ¬ ê°ˆë˜ì˜ ìˆ˜ì—¼ë¿Œë¦¬ê°€ ì‚¬ë°©ìœ¼ë¡œ í¼ì§€ê³  ì¤„ê¸°ê°€ ì ì  ê¸¸ì–´ì ¸ìš”.' : 'â‘¡ ë¿Œë¦¬Â·ì¤„ê¸°Â·ìì´ ì»¤ì§€ë©° í–‡ë¹›ì„ ë°›ì•„ ì—ë„ˆì§€ë¥¼ ë§Œë“¤ì–´ìš”.',
        'â‘¢ ìì´ ë„“ê²Œ í¼ì³ì§€ê³  ì¤„ê¸°ê°€ íŠ¼íŠ¼í•´ì ¸ ìŠ¤ìŠ¤ë¡œ ì„œ ìˆì„ ìˆ˜ ìˆì–´ìš”.',
        `â‘£ ${bloomHint} ê½ƒì´ í”¼ê³ , ${poll}ê°€ ì¼ì–´ë‚˜ ì”¨ë°© ì†ì— ì”¨ê°€ ë§Œë“¤ì–´ì ¸ìš”.`,
        `â‘¤ ${fruitHint}í•˜ê³ , ìµì€ ì”¨ì•—ì´ ë°”ëŒÂ·ë™ë¬¼Â·ì‚¬ëŒ ë“±ì— ì˜í•´ ë„ë¦¬ í¼ì ¸ìš”.`
      ];
      return `<ul class="list-disc pl-5">${lines.map(s=>`<li>${s}</li>`).join('')}</ul>`;
    }

    function buildStageTexts(feats){
      // ë°œì•„: ì”¨ì•—+ë¿Œë¦¬, ì„±ì¥: ì¤„ê¸°+ì, ê°œí™”: ê½ƒ+ìˆ˜ë¶„+ì‹œê¸°, ê²°ì‹¤: ì—´ë§¤
      const pick2 = (arr)=> arr.slice(0,2).join(' Â· ');
      const seedTxt = feats.seed[0] || 'ì”¨ì•—ì´ ë¬¼ì„ ë§Œë‚˜ ì‹¹ì´ ë‚˜ì™€ìš”.';
      const rootTxt = feats.root[0] || 'ë¿Œë¦¬ê°€ ìë¼ í™ì— ë‹¨ë‹¨íˆ ê³ ì •ë¼ìš”.';
      const stemTxt = feats.stem[0] || 'ì¤„ê¸°ê°€ ìë¼ë©° ì‹ë¬¼ì„ ì§€íƒ±í•´ìš”.';
      const leafTxt = pick2(feats.leaf.filter(x=>/ì/.test(x))) || 'ìì´ í¼ì³ì ¸ í–‡ë¹›ì„ ë°›ì•„ìš”.';
      const flowerTxt = pick2(feats.flower.filter(x=>x.startsWith('ê½ƒ '))) || 'ë‹¤ì–‘í•œ ìƒ‰ì˜ ê½ƒì´ í”¼ì–´ìš”';
      const pollTxt = feats.pollination[0] ? `, ${feats.pollination[0]}ë¡œ` : '';
      const bloomTxt = feats.bloom[0] ? ` (${feats.bloom[0]})` : '';
      const fruitTxt = feats.fruit[0] || 'ì—´ë§¤ê°€ ìë¼ ì”¨ì•—ì„ ë³´í˜¸í•´ìš”.';

      return {
        germination: `${seedTxt} ${rootTxt}`,
        growth: `${stemTxt} ${leafTxt}`,
        flowering: `${flowerTxt}${bloomTxt}${pollTxt} ìˆ˜ë¶„ì´ ì¼ì–´ë‚˜ìš”.`,
        fruiting: `${fruitTxt} ìµìœ¼ë©´ ì”¨ì•—ì´ í¼ì ¸ ë‹¤ìŒ í•´ì— ìƒˆ ì‹ë¬¼ì´ ìë¼ìš”.`
      };
    }

    // === ì±„ìš°ê¸° ìœ í‹¸ (ì¤‘ë³µ ì œê±°: ê°™ì€ ë‚´ìš©ì€ í•œ ë²ˆë§Œ) ===
    function fillList(id, arr, fallback){
      const seen = new Set();
      const uniqArr = arr.filter(x=>{ const k = x.toLowerCase(); if(seen.has(k)) return false; seen.add(k); return true; });
      const el = document.getElementById(id);
      el.innerHTML = (uniqArr.length? uniqArr : [fallback]).map(s=>`<li>${s}</li>`).join('');
    }

    async function run(query, lang){
      try{
        setStatus('ê²€ìƒ‰ ì¤‘â€¦'); hide($('#summary')); hide($('#galleryWrap')); hide($('#growthWrap')); hide($('#stageCards')); hide($('#detailWrap')); $('#sections').innerHTML=''; $('#gallery').innerHTML='';

        // ê²€ìƒ‰ íƒ€ì´í‹€ ê²°ì •
        let pick = await searchTitle(query, lang);
        if(!pick){ setStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì´ë‚˜ í•™ëª…ìœ¼ë¡œ ì‹œë„í•´ ë³´ì„¸ìš”.'); toast('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
        const usedLang = pick.lang; const title = pick.title;

        // ìš”ì•½ í‘œì‹œ
        const summary = await getSummary(title, usedLang);
        $('#title').textContent = summary.title || title;
        $('#extract').textContent = summary.extract || '';
        $('#thumb').src = summary.thumbnail?.source || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';
        $('#wikiLink').href = summary.content_urls?.desktop?.page || apiURL(usedLang, `/wiki/${encodeURIComponent(title)}`);
        $('#meta').textContent = `ì–¸ì–´: ${usedLang.toUpperCase()} Â· ë¬¸ì„œ ID: ${summary.pageid || '-'} Â· ë¶„ë¥˜: ${summary.description || ''}`;
        show($('#summary'));

        // ì„¹ì…˜ ìˆ˜ì§‘ â†’ í™”ë©´ + ì½”í¼ìŠ¤ êµ¬ì¶•
        const sections = await getSections(summary.title || title, usedLang);
        const picks = pickSectionsByLabels(sections, usedLang);
        const secWrap = $('#sections');
        const corpusParts = [summary.extract || ''];
        for (const p of picks){
          const html = await getSectionHTML(summary.title || title, p.index, usedLang);
          const clean = stripRefs(html);
          const card = document.createElement('div');
          card.innerHTML = `<article class=\"bg-white rounded-2xl shadow p-5\"><h4 class=\"font-semibold mb-2\">${p.name}</h4><div class=\"prose max-w-none\">${clean}</div></article>`;
          card.querySelectorAll('a').forEach(a=>a.setAttribute('target','_blank'));
          secWrap.appendChild(card.firstElementChild);
          corpusParts.push(htmlToText(clean));
        }
        const corpus = corpusParts.join(' \n ');

        // íŠ¹ì§• ì¶”ì¶œ & ì¤‘ë³µ ì œê±° ì ìš©
        const feats = analyzePlantFeatures(corpus);
        fillList('feat-seed', feats.seed, 'ì”¨ì•—ì˜ ëª¨ì–‘ì„ ê´€ì°°í•´ ê¸°ë¡í•´ ë³´ì„¸ìš”.');
        fillList('feat-root', feats.root, 'ì›ë¿Œë¦¬ì¸ì§€ ìˆ˜ì—¼ë¿Œë¦¬ì¸ì§€ ì‚´í´ë³´ì„¸ìš”.');
        fillList('feat-leaf', feats.leaf, 'ì ë°°ì—´Â·ëª¨ì–‘Â·ê°€ì¥ìë¦¬Â·í¬ê¸°ë¥¼ ê´€ì°°í•´ ë³´ì„¸ìš”.');
        fillList('feat-stem', feats.stem, 'ì¤„ê¸°ì˜ êµµê¸°Â·ë°©í–¥(ì§ë¦½/ë©êµ´)ê³¼ ì„±ì§ˆ(ì´ˆë³¸/ëª©ë³¸)ì„ ì‚´í´ë³´ì„¸ìš”.');
        fillList('feat-flower', feats.flower, 'ê½ƒì˜ ìƒ‰ê³¼ ê½ƒì ìˆ˜, í™”ì„œë¥¼ ì‚´í´ë³´ì„¸ìš”.');
        fillList('feat-bloom', feats.bloom, 'í”¼ëŠ” ê³„ì ˆì´ë‚˜ ë‹¬ì„ ì°¾ì•„ë³´ì„¸ìš”.');
        fillList('feat-fruit', feats.fruit, 'ì—´ë§¤ì˜ í˜•íƒœì™€ ì”¨ì•— í¼ì§ ë°©ë²•ì„ í™•ì¸í•´ ë³´ì„¸ìš”.');
        fillList('feat-pollination', feats.pollination, 'ê³¤ì¶©Â·ë°”ëŒÂ·ìƒˆÂ·ìê°€ ë“± ì–´ë–»ê²Œ ê½ƒê°€ë£¨ê°€ ì˜®ê²¨ê°€ëŠ”ì§€ í™•ì¸í•´ ë³´ì„¸ìš”.');
        show($('#detailWrap'));

        // í•œì‚´ì´ ìš”ì•½(ì´ˆë“±) Â· ë‹¨ê³„ ì¹´ë“œ í…ìŠ¤íŠ¸ (íŠ¹ì§• ë°˜ì˜)
        $('#growthContent').innerHTML = generateElementaryGrowth(corpus, feats);
        const stage = buildStageTexts(feats);
        $('#stage-germination').textContent = stage.germination;
        $('#stage-growth').textContent = stage.growth;
        $('#stage-flowering').textContent = stage.flowering;
        $('#stage-fruiting').textContent = stage.fruiting;
        show($('#growthWrap')); show($('#stageCards'));

        // ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
        const media = await getMediaList(summary.title || title, usedLang);
        const images = (media.items || []).filter(x => x.type === 'image' || x?.type === 'mediainfo');
        if (images.length) {
          $('#gallery').innerHTML = images.slice(0, 16).map(item=>{
            const thumb = item?.thumbnail?.source || item?.srcset?.[0]?.src;
            const src = item?.original?.source || thumb;
            const caption = item?.title || item?.caption?.text || '';
            const credit = item?.artist?.text || item?.credit || '';
            return `<a href=\"${src}\" target=\"_blank\" class=\"group block overflow-hidden rounded-xl border bg-white\"><img src=\"${thumb}\" alt=\"${caption}\" class=\"w-full h-40 object-cover group-hover:scale-105 transition\"/><div class=\"p-2 text-xs text-slate-600\"><div class=\"truncate\">${caption || 'ì´ë¯¸ì§€'}</div><div class=\"text-[10px] text-slate-400 truncate\">${credit || ''}</div></div></a>`;
          }).join('');
          show($('#galleryWrap'));
        }

        setStatus('');
      }catch(e){ console.error(e); setStatus('ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”.'); toast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.'); }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('searchBtn').addEventListener('click', () => run(document.getElementById('q').value.trim() || 'í•´ë°”ë¼ê¸°', document.getElementById('lang').value));
    document.getElementById('q').addEventListener('keydown', (e) => { if (e.key === 'Enter') document.getElementById('searchBtn').click(); });
    document.getElementById('printBtn').addEventListener('click', () => window.print());
    window.addEventListener('DOMContentLoaded', () => run('í•´ë°”ë¼ê¸°', 'ko'));
  </script>
</body>
</html>
