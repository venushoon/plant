<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>식물의 한살이 탐구 (위키백과 + GBIF + iNaturalist + EOL)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- 보안을 위해 DOMPurify 라이브러리 사용을 권장합니다. (주석 해제) -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script> -->
  <style>
    body { font-family: 'Pretendard', system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }
    .prose :where(p,li){line-height:1.8}
    @media print {
      .no-print { display: none !important; }
      .print-grid { grid-template-columns: 1fr 1fr; gap: 16px; }
      a::after { content: " (링크)"; font-size: 10px; }
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
  <!-- 헤더 -->
  <header class="bg-white sticky top-0 z-10 border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-emerald-600">
        <path d="M12 2a7 7 0 00-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 00-7-7zm0 9.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5z"/>
      </svg>
      <div>
        <h1 class="text-xl font-bold">식물의 한살이 탐구</h1>
        <p class="text-sm text-slate-500">위키백과 + GBIF + iNaturalist + EOL</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="printBtn" class="no-print rounded-xl border px-4 py-2 text-sm font-semibold hover:bg-slate-50 transition">인쇄/공유</button>
      </div>
    </div>
  </header>

  <!-- 검색 & 설정 -->
  <section class="max-w-7xl mx-auto px-4 py-4">
    <div class="bg-white rounded-2xl shadow p-4 space-y-3">
      <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
        <div class="flex-1 flex gap-2">
          <input id="q" class="w-full rounded-xl border px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="예: 해바라기, 벚나무, 소나무 ..." />
          <select id="lang" class="rounded-xl border px-3 py-3">
            <option value="ko" selected>한국어 (ko)</option>
            <option value="en">English (en)</option>
          </select>
        </div>
        <button id="searchBtn" class="rounded-xl bg-emerald-600 text-white px-5 py-3 font-semibold hover:bg-emerald-700 transition">검색</button>
      </div>

      <details class="no-print rounded-xl border p-3">
        <summary class="cursor-pointer font-semibold">데이터 소스 옵션</summary>
        <div class="mt-3 grid grid-cols-1 gap-4">
          <div class="space-y-2">
            <label class="flex items-center gap-2"><input id="optGBIF" type="checkbox" class="accent-emerald-600" checked> <span>GBIF (분류/분포)</span></label>
            <label class="flex items-center gap-2"><input id="optINat" type="checkbox" class="accent-emerald-600" checked> <span>iNaturalist (관찰 사진)</span></label>
            <label class="flex items-center gap-2"><input id="optEOL" type="checkbox" class="accent-emerald-600" checked> <span>EOL (설명/이미지)</span></label>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- 본문 -->
  <main class="max-w-7xl mx-auto px-4 pb-20">
    <div id="toast" class="hidden fixed top-20 left-1/2 -translate-x-1/2 max-w-md w-full z-20 rounded-xl bg-amber-50 text-amber-800 border border-amber-200 px-4 py-3 shadow-lg"></div>
    <div id="status" class="mt-8 text-center text-slate-500"></div>

    <!-- 요약 -->
    <section id="summary" class="hidden bg-white rounded-2xl shadow overflow-hidden">
      <div class="md:flex">
        <div class="md:w-1/3">
          <img id="thumb" class="w-full h-64 object-cover" alt="대표 이미지" />
        </div>
        <div class="p-6 md:w-2/3">
          <div class="flex items-start gap-2">
            <h2 id="title" class="text-2xl font-bold"></h2>
            <a id="wikiLink" href="#" target="_blank" class="ml-auto text-emerald-600 text-sm underline">원문 보기</a>
          </div>
          <p id="extract" class="mt-3 text-slate-700 leading-7"></p>
          <div id="meta" class="mt-3 text-xs text-slate-500"></div>
        </div>
      </div>
    </section>

    <!-- 위키백과 섹션 -->
    <section id="sections" class="mt-6 grid lg:grid-cols-3 gap-6 print-grid"></section>

    <!-- 한살이 요약 -->
    <section id="growthWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">한살이 과정 요약 (초등 눈높이)</h3>
      <div id="growthContent" class="bg-white rounded-2xl shadow p-5 text-slate-700 leading-7"></div>
    </section>

    <!-- 단계 카드 -->
    <section id="stageCards" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">발아 → 성장 → 개화 → 결실</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center"><div class="text-4xl">🌱</div><div class="mt-2 font-semibold">발아</div><p id="stage-germination" class="text-sm text-slate-600 mt-1"></p></article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center"><div class="text-4xl">🌿</div><div class="mt-2 font-semibold">성장</div><p id="stage-growth" class="text-sm text-slate-600 mt-1"></p></article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center"><div class="text-4xl">🌼</div><div class="mt-2 font-semibold">개화</div><p id="stage-flowering" class="text-sm text-slate-600 mt-1"></p></article>
        <article class="bg-white rounded-2xl shadow p-5 flex flex-col items-center text-center"><div class="text-4xl">🍎</div><div class="mt-2 font-semibold">결실</div><p id="stage-fruiting" class="text-sm text-slate-600 mt-1"></p></article>
      </div>
    </section>

    <!-- 세부 특징 -->
    <section id="detailWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">세부 특징</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🌰</span><h4 class="font-semibold">씨앗의 생김새</h4></div><ul id="feat-seed" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🫚</span><h4 class="font-semibold">뿌리의 모양</h4></div><ul id="feat-root" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🍃</span><h4 class="font-semibold">잎의 특징</h4></div><ul id="feat-leaf" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🌿</span><h4 class="font-semibold">줄기의 특징</h4></div><ul id="feat-stem" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🌼</span><h4 class="font-semibold">꽃의 특징</h4></div><ul id="feat-flower" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">📅</span><h4 class="font-semibold">피는 시기</h4></div><ul id="feat-bloom" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🍎</span><h4 class="font-semibold">열매의 모양/특징</h4></div><ul id="feat-fruit" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
        <article class="bg-white rounded-2xl shadow p-5 md:col-span-3"><div class="flex items-center gap-2 mb-1"><span class="text-2xl">🪶</span><h4 class="font-semibold">수분 방법</h4></div><ul id="feat-pollination" class="list-disc pl-5 text-slate-700 leading-7"></ul></article>
      </div>
    </section>

    <!-- 외부 소스 패널 -->
    <section id="sourcesWrap" class="mt-6 grid md:grid-cols-2 gap-4"></section>

    <!-- 갤러리 -->
    <section id="galleryWrap" class="mt-6 hidden">
      <h3 class="text-lg font-semibold mb-3">관련 사진/이미지</h3>
      <div id="gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
    </section>
  </main>

  <script>
    const PlantExplorer = {
      // --- 설정 및 상수 ---
      constants: {
        sectionMapKo: ['발아','생장','개화','수분','수정','결실','씨앗','열매','번식','형태','특징','생태','서식','분포'],
        sectionMapEn: ['Germination','Growth','Flowering','Pollination','Fertilization','Fruit','Seed','Reproduction','Characteristics','Description','Ecology','Habitat','Distribution'],
        aliasMap: { '해바라기': 'Sunflower','벚나무': 'Prunus serrulata','소나무': 'Pinus densiflora','장미': 'Rose','튤립': 'Tulip','민들레':'Taraxacum','무궁화':'Hibiscus syriacus' },
        proxyUrl: 'https://corsproxy.io/?'
      },

      // --- DOM 요소 캐싱 ---
      elements: {
        status: document.getElementById('status'),
        toast: document.getElementById('toast'),
        summary: document.getElementById('summary'),
        galleryWrap: document.getElementById('galleryWrap'),
        growthWrap: document.getElementById('growthWrap'),
        stageCards: document.getElementById('stageCards'),
        detailWrap: document.getElementById('detailWrap'),
        sections: document.getElementById('sections'),
        gallery: document.getElementById('gallery'),
        sourcesWrap: document.getElementById('sourcesWrap'),
      },

      // --- API 호출 함수 ---
      api: {
        async fetchJSON(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        },
        async searchTitleRaw(query, lang) {
          const url = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srnamespace=0&srsearch=${encodeURIComponent(query)}&format=json&origin=*`;
          const data = await this.fetchJSON(url);
          return data?.query?.search || [];
        },
        async searchTitle(query, lang) {
          const { aliasMap } = PlantExplorer.constants;
          const { bestSearchHit } = PlantExplorer.utils;
          let hits = await this.searchTitleRaw(query, lang);
          let pick = bestSearchHit(hits, query);
          if (pick) return { title: pick.title, lang };
          if (lang === 'ko' && aliasMap[query]) {
            hits = await this.searchTitleRaw(aliasMap[query], 'en');
            if(hits.length) pick = bestSearchHit(hits, aliasMap[query]);
            if (pick) return { title: pick.title, lang: 'en' };
          }
          if (lang === 'ko') {
            hits = await this.searchTitleRaw(query, 'en');
            if(hits.length) pick = bestSearchHit(hits, query);
            if (pick) return { title: pick.title, lang: 'en' };
          }
          return null;
        },
        getSummary(title, lang) { return this.fetchJSON(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`); },
        async getSections(title, lang) {
            const data = await this.fetchJSON(`https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=sections&format=json&origin=*`);
            return data?.parse?.sections || [];
        },
        async getSectionHTML(title, index, lang) {
            const data = await this.fetchJSON(`https://${lang}.wikipedia.org/w/api.php?action=parse&page=${encodeURIComponent(title)}&prop=text&section=${index}&format=json&origin=*`);
            return data?.parse?.text?.['*'] || '';
        },
        async getMediaList(title, lang) {
            try {
                const data = await this.fetchJSON(`https://${lang}.wikipedia.org/api/rest_v1/page/media-list/${encodeURIComponent(title)}`);
                return { type: 'wikiMedia', items: data.items || [] };
            } catch (e) { console.warn('[WikiMedia]', e); return { type: 'wikiMedia', items: [] }; }
        },
        async fetchGBIF(name) {
          try {
            const data = await this.fetchJSON(`https://api.gbif.org/v1/species/search?q=${encodeURIComponent(name)}`);
            const item = (data.results || [])[0];
            if (!item) return null;
            const bits = ['kingdom', 'phylum', 'class', 'order', 'family', 'genus', 'species'].map(rank => item[rank] ? `${rank.charAt(0).toUpperCase()}: ${item[rank]}` : null).filter(Boolean);
            return { type: 'gbif', text: bits.join(' · '), item };
          } catch (e) { console.warn('[GBIF]', e); return null; }
        },
        async fetchINat(name) {
          try {
            const data = await this.fetchJSON(`https://api.inaturalist.org/v1/taxa?q=${encodeURIComponent(name)}&per_page=12`);
            const images = (data.results || []).map(t => {
              const p = t.default_photo;
              return p && p.square_url ? { thumb: p.medium_url || p.square_url, src: p.url || p.large_url || p.medium_url || p.square_url, caption: t.preferred_common_name || t.name || 'iNaturalist', credit: p.attribution || 'iNaturalist' } : null;
            }).filter(Boolean);
            return { type: 'inat', images };
          } catch (e) { console.warn('[INat]', e); return { type: 'inat', images: [] }; }
        },
        async fetchEOL(name) {
          const proxy = PlantExplorer.constants.proxyUrl;
          try {
              const searchUrl = `${proxy}https://eol.org/api/search/1.0.json?q=${encodeURIComponent(name)}`;
              const searchData = await this.fetchJSON(searchUrl);
              const id = (searchData.results || [])[0]?.id;
               if (id) {
                  const pageUrl = `${proxy}https://eol.org/api/pages/1.0.json?id=${id}&details=true&images_per_page=5&texts_per_page=5`;
                  const pageData = await this.fetchJSON(pageUrl);
                  const texts = (pageData.dataObjects || []).filter(o => o.dataType?.includes('Text')).map(o => o.description).join(' ');
                  const images = (pageData.dataObjects || []).filter(o => o.dataType?.includes('StillImage') && o.eolMediaURL).map(o => ({ thumb: o.eolThumbnailURL || o.thumbnailURL || o.eolMediaURL, src: o.eolMediaURL, caption: o.title || 'EOL Image', credit: o.rightsHolder || o.license || 'EOL' }));
                  return { type: 'eol', text: texts, images: images };
               }
               return { type: 'eol', text: '', images: [] };
          } catch (err) {
               console.warn('[EOL via Proxy]', err);
               return { type: 'eol', text: '', images: [] };
          }
        },
      },
      
      // --- UI 조작 함수 ---
      ui: {
        setStatus(msg = '') { PlantExplorer.elements.status.textContent = msg; },
        toast(msg) {
          const t = PlantExplorer.elements.toast;
          t.textContent = msg;
          t.classList.remove('hidden');
          setTimeout(() => t.classList.add('hidden'), 2800);
        },
        toggle(el, forceShow) { if(el) el.classList.toggle('hidden', !forceShow); },
        resetUI() {
          this.setStatus('검색 중…');
          ['summary', 'galleryWrap', 'growthWrap', 'stageCards', 'detailWrap'].forEach(id => this.toggle(PlantExplorer.elements[id], false));
          ['sections', 'gallery', 'sourcesWrap'].forEach(id => { if(PlantExplorer.elements[id]) PlantExplorer.elements[id].innerHTML = ''; });
        },
        renderSummary(summary, usedLang) {
          document.getElementById('title').textContent = summary.title;
          document.getElementById('extract').textContent = summary.extract || '';
          document.getElementById('thumb').src = summary.thumbnail?.source || 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg';
          document.getElementById('wikiLink').href = summary.content_urls?.desktop?.page || `https://${usedLang}.wikipedia.org/wiki/${encodeURIComponent(summary.title)}`;
          document.getElementById('meta').textContent = `언어: ${usedLang.toUpperCase()} · 페이지 ID: ${summary.pageid || '-'} · 설명: ${summary.description || ''}`;
          this.toggle(PlantExplorer.elements.summary, true);
        },
        async renderSections(title, sections, lang) {
          const secWrap = PlantExplorer.elements.sections;
          const { pickSectionsByLabels, stripRefs, htmlToText } = PlantExplorer.utils;
          const picks = pickSectionsByLabels(sections, lang);
          let corpusParts = [];

          for (const p of picks) {
            const html = await PlantExplorer.api.getSectionHTML(title, p.index, lang);
            const cleanHtml = stripRefs(html);
            corpusParts.push(htmlToText(cleanHtml));

            const article = document.createElement('article');
            article.className = "bg-white rounded-2xl shadow p-5";
            
            const contentDiv = document.createElement('div');
            contentDiv.className = "prose max-w-none";
            
            if (window.DOMPurify) {
              contentDiv.innerHTML = DOMPurify.sanitize(cleanHtml);
            } else {
              contentDiv.innerHTML = cleanHtml;
            }
            
            article.innerHTML = `<h4 class="font-semibold mb-2">${p.name}</h4>`;
            article.appendChild(contentDiv);
            article.querySelectorAll('a').forEach(a => a.setAttribute('target', '_blank'));
            secWrap.appendChild(article);
          }
          return corpusParts.join(' \n ');
        },
        addSourcePanel(title, lines) {
            const wrap = PlantExplorer.elements.sourcesWrap;
            const card = document.createElement('div');
            const list = (lines||[]).filter(Boolean).slice(0,8).map(s=>`<li>${s}</li>`).join('');
            card.innerHTML = `<article class="bg-white rounded-2xl shadow p-5"><div class="font-semibold mb-2">${title}</div><ul class="list-disc pl-5 text-slate-700 leading-7">${list||'<li>추가 정보 없음</li>'}</ul></article>`;
            wrap.appendChild(card.firstElementChild);
        },
        renderFeatures(corpus) {
            const { analyzePlantFeatures, fillList } = PlantExplorer.utils;
            const feats = analyzePlantFeatures(corpus);
            fillList('feat-seed', feats.seed, '씨앗의 모양을 관찰해 기록해 보세요.');
            fillList('feat-root', feats.root, '원뿌리인지 수염뿌리인지 살펴보세요.');
            fillList('feat-leaf', feats.leaf, '잎 배열·모양·가장자리·크기를 관찰해 보세요.');
            fillList('feat-stem', feats.stem, '줄기의 굵기·방향·성질을 살펴보세요.');
            fillList('feat-flower', feats.flower, '꽃의 색·꽃잎 수·화서를 살펴보세요.');
            fillList('feat-bloom', feats.bloom, '피는 계절이나 달을 찾아보세요.');
            fillList('feat-fruit', feats.fruit, '열매의 형태와 씨앗 퍼짐 방법을 확인해 보세요.');
            fillList('feat-pollination', feats.pollination, '어떻게 꽃가루가 옮겨가는지 확인해 보세요.');
            this.toggle(PlantExplorer.elements.detailWrap, true);
            return feats;
        },
        renderGrowthInfo(corpus, feats) {
            const { generateElementaryGrowth, buildStageTexts } = PlantExplorer.utils;
            document.getElementById('growthContent').innerHTML = generateElementaryGrowth(corpus, feats);
            const stage = buildStageTexts(feats);
            document.getElementById('stage-germination').textContent = stage.germination;
            document.getElementById('stage-growth').textContent = stage.growth;
            document.getElementById('stage-flowering').textContent = stage.flowering;
            document.getElementById('stage-fruiting').textContent = stage.fruiting;
            this.toggle(PlantExplorer.elements.growthWrap, true);
            this.toggle(PlantExplorer.elements.stageCards, true);
        },
        renderGallery(wikiImages, extImages) {
            const merged = [...wikiImages, ...extImages].slice(0, 20);
            if (merged.length) {
              PlantExplorer.elements.gallery.innerHTML = merged.map(it =>
                `<a href="${it.src}" target="_blank" class="group block overflow-hidden rounded-xl border bg-white">
                  <img src="${it.thumb}" alt="${it.caption||'image'}" class="w-full h-40 object-cover group-hover:scale-105 transition"/>
                  <div class="p-2 text-xs text-slate-600">
                    <div class="truncate">${it.caption || '이미지'}</div>
                    <div class="text-[10px] text-slate-400 truncate">${it.credit || ''}</div>
                  </div>
                </a>`
              ).join('');
              this.toggle(PlantExplorer.elements.galleryWrap, true);
            }
        }
      },
      
      // --- 유틸리티 및 데이터 처리 함수 ---
      utils: {
        norm: (s) => (s || '').toLowerCase().replace(/\s+/g, ' ').trim(),
        htmlToText(html) {
          const tmp = document.createElement('div');
          tmp.innerHTML = html;
          return (tmp.textContent || tmp.innerText || '').replace(/\s+/g, ' ').trim();
        },
        stripRefs: (html) => html.replaceAll(/<sup[^>]*class=\"reference\"[\s\S]*?<\/sup>/g, '').replaceAll(/<table[^>]*class=\"infobox[\s\S]*?<\/table>/g, '').replaceAll(/<style[\s\S]*?<\/style>/g, '').replaceAll(/<script[\s\S]*?<\/script>/g, '').replaceAll(/\s\(\s*편집\s*\)/g, ''),
        bestSearchHit(list, q) {
          if (!Array.isArray(list) || !list.length) return null;
          const lowerQ = q.toLowerCase();
          const exact = list.find(h => (h.title || '').toLowerCase() === lowerQ);
          if (exact) return exact;
          const contains = list.find(h => (h.title || '').toLowerCase().includes(lowerQ));
          if (contains) return contains;
          return list.sort((a, b) => (a.title || '').length - (b.title || '').length)[0];
        },
        pickSectionsByLabels(sections, lang) {
            const labels = (lang === 'ko') ? PlantExplorer.constants.sectionMapKo : PlantExplorer.constants.sectionMapEn;
            const wanted = (sections || []).map(s => {
                const name = s?.line || '';
                return labels.some(l => name.toLowerCase().includes(l.toLowerCase())) ? { index: s.index, name } : null;
            }).filter(Boolean);
            const seen = new Set();
            return wanted.filter(w => {
                const key = w.name.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            }).slice(0, 8);
        },
        analyzePlantFeatures(corpus){
            const t = PlantExplorer.utils.norm(corpus);
            const extract = (patterns) => {
                const results = new Set();
                for (const pattern of patterns) {
                    const matches = t.matchAll(pattern);
                    for (const match of matches) {
                        let captured = match[1] || match[0];
                        captured = captured.replace(/<[^>]+>/g, '').replace(/(?:씨앗|뿌리|잎|줄기|꽃|열매)은?는?/, '').trim();
                        if (captured && captured.length > 1) {
                            results.add(captured.replace(/[.]$/, ''));
                        }
                    }
                }
                return Array.from(results);
            };

            const leafPatterns = [/잎은\s*([^\.다,]+)/g, /\b(타원형|달걀형|심장형|바늘잎|피침형|선형)이다/g, /잎\s*가장자리는\s*([^\.다,]+)/g, /\b잎이\s*(마주나기|어긋나기|돌려나기|모여나기)/g, /길이\s*([\d\s~-]+cm)의\s*바늘잎/g];
            const stemPatterns = [/줄기는\s*([^\.다,]+)/g, /\b(목질|초본|덩굴성)이다/g, /높이\s*([\d\s~-]+m)/g, /수피는\s*([^\.다,]+)/g];
            const flowerPatterns = [/꽃은\s*([^\.다,]+)/g, /\b(노란색|흰색|붉은색|분홍색|보라색)이다/g, /꽃잎은\s*(\d+장)/g, /\b(두상화서|총상화서|수상화서)이다/g];
            const fruitPatterns = [/열매는\s*([^\.다,]+)/g, /\b(삭과|수과|핵과|장과)이다/g];
            
            return {
                seed: extract([/씨앗은\s*([^\.다,]+)/g]),
                root: extract([/뿌리는\s*([^\.다,]+)/g, /\b(원뿌리|수염뿌리|땅속줄기)이다/g]),
                leaf: extract(leafPatterns),
                stem: extract(stemPatterns),
                flower: extract(flowerPatterns),
                bloom: extract([/(\d{1,2}[-~]\d{1,2}월)에\s*핀다/g, /(봄|여름|가을|겨울)에\s*꽃이\s*핀다/g]),
                fruit: extract(fruitPatterns),
                pollination: extract([/(충매화|풍매화)이다/g, /(곤충|바람)에\s*의해\s*수분된다/g])
            };
        },
        generateElementaryGrowth(corpus, feats){
            const hasTap = feats.root.some(r => r.includes('원뿌리'));
            const hasFib = feats.root.some(r => r.includes('수염뿌리'));
            const poll = feats.pollination[0] || '수분(꽃가루받이)';
            const bloomHint = feats.bloom[0] || '알맞은 계절에';
            const fruitHint = feats.fruit[0] || '열매가 자라 씨앗을 보호';

            const lines = [
                '① 씨앗이 물을 빨아들여 껍질이 부드러워지면 작은 뿌리와 싹이 나와요.',
                hasTap ? '② 굵은 원뿌리가 아래로 길게 자라고 줄기가 위로 자라요.' : hasFib ? '② 여러 갈래의 수염뿌리가 사방으로 퍼지고 줄기가 점점 길어져요.' : '② 뿌리·줄기·잎이 커지며 햇빛을 받아 에너지를 만들어요.',
                '③ 잎이 넓게 펼쳐지고 줄기가 튼튼해져 스스로 서 있을 수 있어요.',
                `④ ${bloomHint} 꽃이 피고, ${poll}가 일어나 씨방 속에 씨가 만들어져요.`,
                `⑤ ${fruitHint}하고, 익은 씨앗이 바람·동물·사람 등에 의해 널리 퍼져요.`
            ];
            return `<ul class="list-disc pl-5">${lines.map(s=>`<li>${s}</li>`).join('')}</ul>`;
        },
        buildStageTexts(feats){
            const pick2 = (arr)=> arr.slice(0,2).join(' · ');
            const seedTxt = feats.seed[0] || '씨앗이 물을 만나 싹이 나와요.';
            const rootTxt = feats.root[0] || '뿌리가 자라 흙에 단단히 고정돼요.';
            const stemTxt = feats.stem[0] || '줄기가 자라며 식물을 지탱해요.';
            const leafTxt = pick2(feats.leaf.filter(x=>/잎/.test(x))) || '잎이 펼쳐져 햇빛을 받아요.';
            const flowerTxt = pick2(feats.flower.filter(x=>x.startsWith('꽃 '))) || '다양한 색의 꽃이 피어요';
            const pollTxt = feats.pollination[0] ? `, ${feats.pollination[0]}로` : '';
            const bloomTxt = feats.bloom[0] ? ` (${feats.bloom[0]})` : '';
            const fruitTxt = feats.fruit[0] || '열매가 자라 씨앗을 보호해요.';
            return {
                germination: `${seedTxt} ${rootTxt}`,
                growth: `${stemTxt} ${leafTxt}`,
                flowering: `${flowerTxt}${bloomTxt}${pollTxt} 수분이 일어나요.`,
                fruiting: `${fruitTxt} 익으면 씨앗이 퍼져 다음 해에 새 식물이 자라요.`
            };
        },
        fillList(id, arr, fallback){
            const uniqArr = [...new Set(arr)];
            const el = document.getElementById(id);
            el.innerHTML = (uniqArr.length ? uniqArr : [fallback]).map(s=>`<li>${s}</li>`).join('');
        },
      },
      
      // --- 메인 실행 함수 ---
      async run(query, lang) {
        try {
          this.ui.resetUI();

          const pick = await this.api.searchTitle(query, lang);
          if (!pick) {
            this.ui.setStatus('검색 결과가 없습니다. 다른 이름이나 학명으로 시도해 보세요.');
            this.ui.toast('검색 결과가 없습니다.');
            return;
          }
          const { title, lang: usedLang } = pick;
          
          const summary = await this.api.getSummary(title, usedLang);
          this.ui.renderSummary(summary, usedLang);
          
          const sectionsData = await this.api.getSections(title, usedLang);
          const wikiCorpus = await this.ui.renderSections(title, sectionsData, usedLang);
          let corpus = `${summary.extract || ''} ${wikiCorpus}`;

          const promises = [];
          
          promises.push(this.api.getMediaList(title, usedLang));
          if (document.getElementById('optGBIF').checked) promises.push(this.api.fetchGBIF(title));
          if (document.getElementById('optINat').checked) promises.push(this.api.fetchINat(title));
          if (document.getElementById('optEOL').checked) promises.push(this.api.fetchEOL(title));

          const results = await Promise.allSettled(promises);
          
          let extImages = [];
          for (const res of results) {
            if (res.status === 'fulfilled' && res.value) {
                const data = res.value;
                corpus += ` ${data.text || ''}`;
                if (data.images) extImages.push(...data.images);

                switch (data.type) {
                    case 'gbif':
                        this.ui.addSourcePanel('GBIF 분류', data.text.split(' · '));
                        break;
                    case 'inat':
                        if (data.images.length > 0) this.ui.addSourcePanel('iNaturalist', ['관찰 사진이 갤러리에 추가되었습니다.']);
                        break;
                    case 'eol':
                        if (data.text) this.ui.addSourcePanel('EOL (Encyclopedia of Life)', ['EOL의 설명과 이미지를 추가했습니다.']);
                        break;
                }
            }
          }
          
          const feats = this.ui.renderFeatures(corpus);
          this.ui.renderGrowthInfo(corpus, feats);
          
          const wikiMediaResult = results.find(r => r.status === 'fulfilled' && r.value?.type === 'wikiMedia');
          const wikiImages = (wikiMediaResult?.value?.items || [])
            .filter(x => x.type === 'image' || x.type === 'mediainfo')
            .map(item => {
              const thumb = item?.thumbnail?.source || item?.srcset?.[0]?.src;
              return { thumb, src: item?.original?.source || thumb, caption: item?.title || item?.caption?.text || '', credit: item?.artist?.text || item?.credit || 'Wikipedia' };
            });
            
          this.ui.renderGallery(wikiImages, extImages);
          this.ui.setStatus('');

        } catch (e) {
          console.error(e);
          this.ui.setStatus('데이터를 불러오는 중 오류가 발생했습니다.');
          this.ui.toast('오류 발생. 네트워크를 확인해 주세요.');
        }
      },

      // --- 이벤트 리스너 초기화 ---
      init() {
        document.getElementById('searchBtn').addEventListener('click', () => {
          const query = document.getElementById('q').value.trim() || '해바라기';
          const lang = document.getElementById('lang').value;
          this.run(query, lang);
        });
        document.getElementById('q').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') document.getElementById('searchBtn').click();
        });
        document.getElementById('printBtn').addEventListener('click', () => window.print());
      }
    };

    // DOM이 완전히 로드된 후에 스크립트 초기화 실행
    document.addEventListener('DOMContentLoaded', () => {
        PlantExplorer.init();
        PlantExplorer.run('해바라기', 'ko');
    });
  </script>
</body>
</html>
